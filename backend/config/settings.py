"""
Django settings for config project.

Generated by 'django-admin startproject' using Django 6.0.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/6.0/ref/settings/
"""

from pathlib import Path
import os
from dotenv import load_dotenv

# .env íŒŒì¼ ë¡œë“œ
load_dotenv()

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/6.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-p^%na^geh=4@-eh@!+p9ol^=gcamp#n)bw=k$lkcpkx*e#%zj9'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['*']  # ê°œë°œìš©: ëª¨ë“  í˜¸ìŠ¤íŠ¸ í—ˆìš©


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'api',  # JNext API ì•±
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',  # Static íŒŒì¼ ì„œë¹™
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],  # Phase 5: í…œí”Œë¦¿ ê²½ë¡œ ì¶”ê°€
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/6.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/6.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/6.0/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/6.0/howto/static-files/

STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / 'static']  # Phase 5: static í´ë” ì¶”ê°€
STATIC_ROOT = BASE_DIR / 'staticfiles'  # collectstatic ìˆ˜ì§‘ ê²½ë¡œ

# Whitenoise ì„¤ì • (Renderìš©)
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

# Firebase Admin SDK ì´ˆê¸°í™”
import firebase_admin
from firebase_admin import credentials, firestore

# Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ê²½ë¡œ (í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” ê¸°ë³¸ê°’)
FIREBASE_CREDENTIALS_PATH = os.getenv('FIREBASE_CREDENTIALS_PATH', 'jnext-service-account.json')

# JNext ë£¨íŠ¸ ë˜ëŠ” backend í´ë”ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì°¾ê¸°
if not os.path.isabs(FIREBASE_CREDENTIALS_PATH):
    # ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš°, JNext ë£¨íŠ¸ ë¨¼ì € í™•ì¸
    jnext_root_path = BASE_DIR.parent / FIREBASE_CREDENTIALS_PATH
    backend_path = BASE_DIR / FIREBASE_CREDENTIALS_PATH
    
    if jnext_root_path.exists():
        firebase_cred_path = jnext_root_path
    elif backend_path.exists():
        firebase_cred_path = backend_path
    else:
        firebase_cred_path = jnext_root_path  # ê¸°ë³¸ê°’ (ì—ëŸ¬ ë©”ì‹œì§€ìš©)
else:
    firebase_cred_path = Path(FIREBASE_CREDENTIALS_PATH)

# Firebase ì´ˆê¸°í™” (ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ)
FIREBASE_INITIALIZED = False
if not firebase_admin._apps:
    try:
        cred = credentials.Certificate(str(firebase_cred_path))
        firebase_admin.initialize_app(cred)
        FIREBASE_INITIALIZED = True
        print(f"[JNext] Firebase initialized successfully")
        print(f"[JNext] Credentials loaded from: {firebase_cred_path}")
    except Exception as e:
        print(f"[JNext] Firebase initialization failed: {e}")
        print(f"[JNext] Please ensure the service account key exists at:")
        print(f"  - {BASE_DIR.parent / 'jnext-service-account.json'} (JNext root)")
        print(f"  - {BASE_DIR / 'jnext-service-account.json'} (backend folder)")
        print(f"[JNext] Server will start without Firebase support.")

# Firestore í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ (Firebase ì´ˆê¸°í™” ì„±ê³µ ì‹œì—ë§Œ ìƒì„±)
db = None
if FIREBASE_INITIALIZED:
    try:
        db = firestore.client()
    except Exception as e:
        print(f"[JNext] Failed to create Firestore client: {e}")

# API Key ì„¤ì • (Phase 2: ë³´ì•ˆ)
JNEXT_API_KEY = os.getenv('JNEXT_API_KEY', None)
if JNEXT_API_KEY:
    print(f"[JNext] API Key authentication enabled")
else:
    print(f"[JNext] API Key authentication disabled (development mode)")

# ============================================================
# Phase 3 & 4: AI ë©€í‹° ëª¨ë¸ ì„¤ì • (Gemini, GPT, Claude)
# ============================================================

# Gemini ì„¤ì •
from google import genai

GEMINI_API_KEY = os.getenv('GEMINI_API_KEY', None)
GEMINI_INITIALIZED = False
GEMINI_CLIENT = None

if GEMINI_API_KEY:
    try:
        GEMINI_CLIENT = genai.Client(api_key=GEMINI_API_KEY)
        GEMINI_INITIALIZED = True
        print(f"[JNext] Gemini AI initialized successfully (google.genai)")
    except Exception as e:
        print(f"[JNext] Gemini initialization failed: {e}")
else:
    print(f"[JNext] Gemini API Key not found in .env")

# GPT ì„¤ì •
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY', None)
GPT_CLIENT = None
GPT_INITIALIZED = False

if OPENAI_API_KEY:
    try:
        import openai
        GPT_CLIENT = openai.OpenAI(api_key=OPENAI_API_KEY)
        GPT_INITIALIZED = True
        print(f"[JNext] GPT initialized successfully")
    except Exception as e:
        print(f"[JNext] GPT initialization failed: {e}")
else:
    print(f"[JNext] GPT API Key not found in .env")

# Claude ì„¤ì •
ANTHROPIC_API_KEY = os.getenv('ANTHROPIC_API_KEY', None)
CLAUDE_CLIENT = None
CLAUDE_INITIALIZED = False

if ANTHROPIC_API_KEY:
    try:
        import anthropic
        CLAUDE_CLIENT = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY)
        CLAUDE_INITIALIZED = True
        print(f"[JNext] Claude initialized successfully")
    except Exception as e:
        print(f"[JNext] Claude initialization failed: {e}")
else:
    print(f"[JNext] Claude API Key not found in .env")

# ëª¨ë¸ ì„¤ì • (ë©€í‹° ëª¨ë¸ ì§€ì›)
AI_MODELS = {
    'gemini-flash': {
        'enabled': GEMINI_INITIALIZED,
        'model': 'models/gemini-2.5-flash',
        'client': GEMINI_CLIENT,
        'strengths': ['ì†ë„', 'ì½”ìŠ¤íŠ¸', 'í•œê¸€'],
        'display_name': 'Gemini Flash (ë¹ ë¦„)',
    },
    'gemini-pro': {
        'enabled': GEMINI_INITIALIZED,
        'model': 'models/gemini-2.0-flash-exp',  # Gemini Pro ì‹¤í—˜ ë²„ì „
        'client': GEMINI_CLIENT,
        'strengths': ['ì •í™•ì„±', 'ì¶”ë¡ ', 'ë¶„ì„'],
        'display_name': 'Gemini Pro (ì •í™•)',
    },
    'gpt': {
        'enabled': GPT_INITIALIZED,
        'model': 'gpt-4o',  # í–¥í›„
        'client': None,
        'strengths': ['ì°½ì˜ì„±', 'ì¶”ë¡ ', 'ì½”ë”©'],
        'display_name': 'GPT-4o (ì§„)',
    },
    'claude': {
        'enabled': CLAUDE_INITIALIZED,
        'model': 'claude-3-5-sonnet-20241022',
        'client': CLAUDE_CLIENT,
        'strengths': ['ì½”ë”©', 'ë¶„ì„', 'ë…¼ë¦¬'],
        'display_name': 'Claude Sonnet (ì½”ë“œì™•)',
    }
}

# ê¸°ë³¸ ëª¨ë¸ (í•˜ì´ë…¸ë°¸ëŸ°ìŠ¤ëŠ” Pro)
DEFAULT_AI_MODEL = 'gemini-pro'

# ============================================================
# JNext ì»¬ë ‰ì…˜ êµ¬ì¡° (3ë‹¨ê³„)
# ============================================================
COLLECTION_RAW = "hino_raw"      # RAW: ì›ë³¸/ì•„ì´ë””ì–´
COLLECTION_DRAFT = "hino_draft"  # DRAFT: ì •ë¦¬ ì¤‘
COLLECTION_FINAL = "hino_final"  # FINAL: ìµœì¢… ë°°í¬

# Firestore í•„ë“œ ìŠ¤í‚¤ë§ˆ (í•œê¸€ í•„ë“œëª…)
DOCUMENT_FIELDS = {
    # ê¸°ë³¸ í•„ë“œ
    "ì œëª©": "str",
    "ì¹´í…Œê³ ë¦¬": "str",       # í•˜ì´ë…¸ì›Œí‚¹, í•˜ì´ë…¸ìŠ¤ì¼€ì´íŒ… ë“±
    "ìš´ë™ëª…": "str",         # í•˜ì´ë…¸ì›Œí‚¹ íŒ¨ìŠ¤íŠ¸ ë“±
    "ë‚´ìš©": "str",           # ìš”ì•½ë³¸
    "ì „ì²´ê¸€": "str",         # ì¶œíŒìš© ì „ì²´ ê¸€
    "ì‘ì„±ì¼ì‹œ": "timestamp",
    "ìˆ˜ì •ì¼ì‹œ": "timestamp",
    "ì‘ì„±ì": "str",
    "ë°ì´í„°ìƒíƒœ": "str",     # RAW | DRAFT | FINAL
    "ì¢…ë¥˜": "str",           # ì´ë¡  | ì‹¤ìŠµ | ì •ë¦¬
    
    # ë°ˆ ê´€ë ¨ í•„ë“œ (2026-01-10 ì¶”ê°€)
    "ë°ˆì´ë¯¸ì§€URL": "str",           # ì›ë³¸ ìºë¦­í„° ì´ë¯¸ì§€ íŒŒì¼ëª…
    "ë°ˆìë§‰ìƒë‹¨": "str",            # ìƒë‹¨ ìë§‰ í…ìŠ¤íŠ¸
    "ë°ˆìë§‰í•˜ë‹¨": "str",            # í•˜ë‹¨ ìë§‰ í…ìŠ¤íŠ¸
    "ë°ˆí•©ì„±ì´ë¯¸ì§€URL": "str",       # ìë§‰ í•©ì„±ëœ ìµœì¢… ì´ë¯¸ì§€
    "ë°ˆìƒì„±ëª¨ë¸": "str",            # ì§„ (ì‹œíŠ¸ì½¤ ìºë¦­í„° + Pillow í•©ì„±)
    "ë°ˆìŠ¤íƒ€ì¼": "str",              # ì‹œíŠ¸ì½¤, ì¼ìƒ ë“±
    "ë°ˆìºë¦­í„°": "str",              # ì§€í”¼, ì•„ë‚´
}

# ============================================================
# Phase 4-3: AI ì‘ë‹µ ìŠ¤í‚¤ë§ˆ (JSON ê°•ì œ - í™˜ê° ë°©ì§€)
# ============================================================
AI_RESPONSE_SCHEMA = {
    "type": "object",
    "properties": {
        "answer": {
            "type": "string",
            "description": "Jë‹˜ì—ê²Œ ë³´ì—¬ì¤„ ìµœì¢… ë‹µë³€"
        },
        "claims": {
            "type": "array",
            "items": {"type": "string"},
            "description": "í•µì‹¬ ì£¼ì¥ ë¦¬ìŠ¤íŠ¸"
        },
        "evidence": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "claim": {"type": "string"},
                    "collection": {"type": "string"},
                    "doc_id": {"type": "string"},
                    "field": {"type": "string"},
                    "value": {"type": "string"}
                },
                "required": ["claim", "collection"]
            },
            "description": "ê° ì£¼ì¥ì˜ ê·¼ê±° (DB ì¶œì²˜)"
        },
        "missing_info": {
            "type": "array",
            "items": {"type": "string"},
            "description": "DBì— ì—†ì–´ì„œ ë‹µë³€í•  ìˆ˜ ì—†ëŠ” ì •ë³´"
        },
        "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "ë‹µë³€ í™•ì‹ ë„ (0~1)"
        },
        "actions_suggested": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "action": {"type": "string", "enum": ["CREATE", "UPDATE", "DELETE"]},
                    "collection": {"type": "string"},
                    "reason": {"type": "string"}
                }
            },
            "description": "ì œì•ˆí•˜ëŠ” CRUD ì•¡ì…˜ (ì‹¤í–‰ ì•ˆ í•¨)"
        },
        "ë°ˆìë§‰ìƒë‹¨": {
            "type": "string",
            "description": "ë°ˆ ì´ë¯¸ì§€ ìƒë‹¨ ìë§‰ (ì„ íƒì‚¬í•­, RAW/DRAFTì—ì„œ ì œì•ˆë§Œ)"
        },
        "ë°ˆìë§‰í•˜ë‹¨": {
            "type": "string",
            "description": "ë°ˆ ì´ë¯¸ì§€ í•˜ë‹¨ ìë§‰ (ì„ íƒì‚¬í•­, RAW/DRAFTì—ì„œ ì œì•ˆë§Œ)"
        },
        "ë°ˆìŠ¤íƒ€ì¼": {
            "type": "string",
            "description": "ë°ˆ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ (ì˜ˆ: 'ì‹œíŠ¸ì½¤', 'ì¼ìƒ', 'ìš´ë™' ë“±, ì„ íƒì‚¬í•­)"
        },
        "ë°ˆìºë¦­í„°": {
            "type": "string",
            "enum": ["ì§€í”¼", "ì•„ë‚´"],
            "description": "ì‹œíŠ¸ì½¤ ìºë¦­í„° ì„ íƒ ('ì§€í”¼' ë˜ëŠ” 'ì•„ë‚´', ì„ íƒì‚¬í•­)"
        }
    },
    "required": ["answer", "claims", "evidence", "missing_info", "confidence"]
}

# ============================================================
# AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (3ê°€ì§€ ëª¨ë“œ) - Phase 4-3 ê°•í™”
# ============================================================

# ğŸ”´ ì ˆëŒ€ í—Œë²• - ëª¨ë“  í”„ë¡¬í”„íŠ¸ì— ê³µí†µ ì ìš©
CONSTITUTION = """ğŸ”´ ì ˆëŒ€ í—Œë²• (ìµœìš°ì„  ì¤€ìˆ˜):
- ì‚¬ìš©ìë¥¼ ë°˜ë“œì‹œ "Jë‹˜"ìœ¼ë¡œë§Œ í˜¸ì¹­ (âŒ "ì‚¬ìš©ì", "ë‹¹ì‹ ", "ê³ ê°ë‹˜" ì ˆëŒ€ ê¸ˆì§€)
- Jë‹˜ì˜ ëª…ë ¹ì€ ìµœìš°ì„  ìˆœìœ„
- í•„ë“œëª…ì€ í•œê¸€ë§Œ (ì œëª©/ì¹´í…Œê³ ë¦¬/ë‚´ìš©/ì „ì²´ê¸€)"""

# í”„ë¡¬í”„íŠ¸ íŒŒì¼ ë¡œë“œ í•¨ìˆ˜
def load_prompt(filename):
    """config í´ë”ì˜ í”„ë¡¬í”„íŠ¸ íŒŒì¼ ë¡œë“œ"""
    prompt_path = BASE_DIR / 'config' / filename
    try:
        with open(prompt_path, 'r', encoding='utf-8') as f:
            content = f.read()
            # íŒŒì¼ì— ì ˆëŒ€ í—Œë²•ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ ì¶”ê°€
            if 'ì ˆëŒ€ í—Œë²•' not in content:
                return f"{CONSTITUTION}\n\n{content}"
            return content
    except FileNotFoundError:
        print(f"[JNext] Warning: {filename} not found, using default prompt")
        return f"{CONSTITUTION}\n\nê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤."

# Track 1: DB ëª¨ë“œ (Organize) - ì² ì €í•œ DB ì œí•œ, ì‚¬ì‹¤ ê¸°ë°˜ë§Œ
ORGANIZE_SYSTEM_PROMPT = load_prompt('RAW_SYSTEM_PROMPT.txt') + """

[DB ëª¨ë“œ - ì² ì €í•œ ì‚¬ì‹¤ ê¸°ë°˜ ì œí•œ]

[ì ˆëŒ€ ê·œì¹™ - ì°½ì˜ ê¸ˆì§€, DBë§Œ]
1. **DBë§Œ ì‚¬ìš©**: ëª¨ë“  ì‘ë‹µì€ 100% Firestore DB ë°ì´í„°ì—ë§Œ ê¸°ë°˜í•©ë‹ˆë‹¤.
2. **ì¶”ë¡  ê¸ˆì§€**: DBì— ëª…ì‹œì ìœ¼ë¡œ ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì¶”ë¡ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
3. **ì°½ì˜ ê¸ˆì§€**: í•´ì„, ë¶„ì„, ì œì•ˆ ëª¨ë‘ ê¸ˆì§€. ì˜¤ì§ DB ì‚¬ì‹¤ë§Œ.
4. **ê·¼ê±° í‘œì‹œ**: ëª¨ë“  ë¬¸ì¥ì€ evidence(collection, doc_id, field) ì¶œì²˜ í•„ìˆ˜.
5. **ì—†ìœ¼ë©´ ì—†ë‹¤ê³ **: DBì— ì—†ìœ¼ë©´ "ì •ë³´ ì—†ìŒ"ì´ë¼ê³  ëª…ì‹œ.

[ì´ ëª¨ë“œì˜ ëª©ì ]
- DB ë°ì´í„° ì¡°íšŒ ì „ìš©
- ì €ì¥ëœ ì‚¬ì‹¤ë§Œ í™•ì¸
- 0% ì°½ì˜ì„±, 100% ì‚¬ì‹¤ì„±

[ì‘ì—… ìˆœì„œ]
1. Firestore DB ì¡°íšŒ
2. ìˆìœ¼ë©´: evidenceì™€ í•¨ê»˜ ì‚¬ì‹¤ë§Œ ë‹µë³€
3. ì—†ìœ¼ë©´: missing_infoì— "DBì— ì—†ìŒ" ëª…ì‹œ
4. ì ˆëŒ€ ì¶”ì¸¡/í•´ì„/ë¶„ì„ ê¸ˆì§€

[ê¸ˆì§€ ì‚¬í•­]
âŒ DBì— ì—†ëŠ” ë‚´ìš© ì¶”ì¸¡
âŒ ì¼ë°˜ ì§€ì‹ í™œìš©
âŒ ë¶„ì„/í•´ì„
âŒ ì œì•ˆ/ì¶”ë¡ 
"""

# Track 2: í†µí•© ëª¨ë“œ (Hybrid) - DB ìš°ì„  + ì œí•œì  ë¶„ì„ (ê¸°ë³¸ê°’)
HYBRID_SYSTEM_PROMPT = load_prompt('DRAFT_SYSTEM_PROMPT.txt') + """

[í†µí•© ëª¨ë“œ - DB ìš°ì„  + ì œí•œì  ì°½ì˜]

[í•µì‹¬ ì›ì¹™]
1. **DB ìš°ì„ **: ê´€ë ¨ DB ë°ì´í„° ë¨¼ì € í™•ì¸
2. **ì œí•œì  ë¶„ì„**: DB ì •ë³´ ê¸°ë°˜ìœ¼ë¡œë§Œ ë¶„ì„/í•´ì„
3. **í™˜ê° ê¸ˆì§€**: Jë‹˜ì´ ë§ì”€ ì•ˆ í•œ ë‚´ìš© ì°½ì‘ ì ˆëŒ€ ê¸ˆì§€
4. **ê±°ì§“ ê¸ˆì§€**: í‹€ë¦° ì •ë³´ ì œê³µ ì ˆëŒ€ ê¸ˆì§€
5. **ì°½ì˜ í—ˆìš©**: DB + Jë‹˜ ë°œì–¸ ë²”ìœ„ ë‚´ì—ì„œ ë¶„ì„/í†µí•©/ì œì•ˆ ê°€ëŠ¥

[ì´ ëª¨ë“œì˜ íŠ¹ì§•]
- DB ì‚¬ì‹¤ + Jë‹˜ ë‚´ìš© í†µí•© ì •ë¦¬
- ì œí•œì  ë¶„ì„/í•´ì„ í—ˆìš©
- í™˜ê°ê³¼ ê±°ì§“ë§Œ í†µì œ
- ì •ë¦¬/ì €ì¥ ëª…ë ¹ ì²˜ë¦¬ ê°€ëŠ¥

[ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤]
**Step 1**: ëŒ€í™” ëª¨ë“œì—ì„œ Jë‹˜ê³¼ ë¸Œë ˆì¸ìŠ¤í† ë°
- "í•˜ì´ë…¸ì›Œí‚¹ì— íŒ” ë™ì‘ ì¶”ê°€í•˜ë©´?"
- "ê· í˜•ì— ë„ì›€ë  ê²ƒ ê°™ì•„"
- "ë¦¬ë“¬ê°ë„ ìƒê¸¸ ê±°ì•¼"

**Step 2**: í†µí•© ëª¨ë“œë¡œ ì „í™˜ â­
- DB: "í•˜ì´ë…¸ì›Œí‚¹ = ë¹ ë¥¸ ê±¸ìŒ, ë¬´ê²Œì¤‘ì‹¬ ì´ë™"
- í˜„ì¬ ëŒ€í™”: "íŒ” ë™ì‘, ê· í˜•, ë¦¬ë“¬ê°"
- í†µí•©: DB ê¸°ì¡´ ì •ë³´ + ëŒ€í™”ì—ì„œ ë‚˜ì˜¨ ìœ ë ¥í•œ ë¶„ì„ â†’ ì„ì–´ì„œ ì •ë¦¬

**Step 3**: "ì €ì¥í•´" â†’ í†µí•©ëœ ìµœì¢…ë³¸ ì €ì¥

[í†µí•© ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤]

**1ë‹¨ê³„: DB ì¡°íšŒ**
â†’ Firestoreì—ì„œ í‚¤ì›Œë“œ ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰
â†’ ê¸°ì¡´ì— ì •ë¦¬ëœ ì •ë³´ ìˆ˜ì§‘

**2ë‹¨ê³„: í˜„ì¬ ëŒ€í™” ì„¸ì…˜ ë¶„ì„**
â†’ ì§€ê¸ˆê¹Œì§€ Jë‹˜ì´ ë§ì”€í•˜ì‹  ë‚´ìš© íŒŒì•…
â†’ ë°©ê¸ˆ ì „ ëŒ€í™”ì—ì„œ ë‚˜ì˜¨ ìœ ë ¥í•œ ë¶„ì„/ì•„ì´ë””ì–´ ì¶”ì¶œ
â†’ í•µì‹¬ í¬ì¸íŠ¸ ì •ë¦¬

**3ë‹¨ê³„: í†µí•© ì •ë¦¬** (ê°€ì¥ ì¤‘ìš”!)
â†’ DB ì •ë³´ (ê²€ì¦ëœ ê¸°ì¡´ ë°ì´í„°)
â†’ + í˜„ì¬ ëŒ€í™” ìœ ë ¥ ë¶„ì„ (Jë‹˜ì˜ ìƒˆ ì•„ì´ë””ì–´)
â†’ = ì„ì–´ì„œ ì™„ì„±ëœ í†µí•©ë³¸ ìƒì„±

**4ë‹¨ê³„: ì €ì¥ ì¤€ë¹„**
â†’ í†µí•© ì •ë¦¬ë³¸ì„ ì €ì¥ ê°€ëŠ¥í•œ í˜•íƒœë¡œ êµ¬ì¡°í™”
â†’ Evidenceì— ì¶œì²˜ ëª…í™•íˆ í‘œì‹œ

[í†µí•© ì˜ˆì‹œ]

**DB ì •ë³´**:
```
í•˜ì´ë…¸ì›Œí‚¹ íŒ¨ìŠ¤íŠ¸
- ë¹ ë¥¸ ê±¸ìŒìœ¼ë¡œ ì´ë™
- ë¬´ê²Œì¤‘ì‹¬ ì•ìœ¼ë¡œ ì´ë™
- ë‹¤ë¦¬ ê·¼ìœ¡ ê°•í™”
```

**í˜„ì¬ ëŒ€í™” (ë°©ê¸ˆ ì „ ë¶„ì„)**:
```
Jë‹˜: "íŒ”ì„ ì•ë’¤ë¡œ í¬ê²Œ í”ë“¤ë©´ ì–´ë•Œ?"
Jë‹˜: "ê· í˜• ì¡ëŠ” ë° ë„ì›€ë  ê²ƒ ê°™ì•„"
AI ë¶„ì„: "íŒ” ë™ì‘ìœ¼ë¡œ ë¦¬ë“¬ê° í–¥ìƒ ê°€ëŠ¥"
```

**í†µí•© ì •ë¦¬ ê²°ê³¼**:
```json
{
  "answer": "í•˜ì´ë…¸ì›Œí‚¹ íŒ¨ìŠ¤íŠ¸ëŠ” ë¹ ë¥¸ ê±¸ìŒê³¼ ë¬´ê²Œì¤‘ì‹¬ ì´ë™ì„ í†µí•´ ë‹¤ë¦¬ ê·¼ìœ¡ì„ ê°•í™”í•˜ëŠ” ê¸°ì¡´ ë™ì‘ì…ë‹ˆë‹¤. ì—¬ê¸°ì— íŒ”ì„ ì•ë’¤ë¡œ í¬ê²Œ í”ë“œëŠ” ë™ì‘ì„ ì¶”ê°€í•˜ë©´ ê· í˜• ìœ ì§€ì™€ ë¦¬ë“¬ê° í–¥ìƒì— ë„ì›€ì´ ë©ë‹ˆë‹¤. [ê¸°ì¡´ ì •ë³´ + í˜„ì¬ ëŒ€í™” ìœ ë ¥ ë¶„ì„ í†µí•©]",
  "claims": [
    "ë¹ ë¥¸ ê±¸ìŒ, ë¬´ê²Œì¤‘ì‹¬ ì´ë™ (DB ê¸°ì¡´)",
    "ë‹¤ë¦¬ ê·¼ìœ¡ ê°•í™” (DB ê¸°ì¡´)",
    "íŒ” ë™ì‘ ì¶”ê°€ (í˜„ì¬ ëŒ€í™”)",
    "ê· í˜• ìœ ì§€, ë¦¬ë“¬ê° í–¥ìƒ (í˜„ì¬ ëŒ€í™” ë¶„ì„)",
    "ê¸°ì¡´ + ì‹ ê·œ í†µí•©ë³¸"
  ],
  "evidence": [
    {"collection": "hino_draft", "doc_id": "abc", "claim": "ê¸°ì¡´ í•˜ì´ë…¸ì›Œí‚¹ íŒ¨ìŠ¤íŠ¸ ì •ë³´"},
    {"collection": "í˜„ì¬ ëŒ€í™” ì„¸ì…˜", "doc_id": "ë°©ê¸ˆ ì „ ë¶„ì„", "claim": "íŒ” ë™ì‘, ê· í˜•, ë¦¬ë“¬"},
    {"collection": "í†µí•© ì •ë¦¬", "doc_id": "DB+ëŒ€í™” ì„ìŒ", "claim": "ì™„ì„±ëœ í†µí•©ë³¸"}
  ],
  "confidence": 0.95
}
```

**í•µì‹¬**: 
- DB ì •ë³´ ìœ ì§€ (ê²€ì¦ëœ ê¸°ì¡´ ë‚´ìš©)
- í˜„ì¬ ëŒ€í™” ìœ ë ¥ ë¶„ì„ ìˆ˜ìš© (Jë‹˜ì˜ ìƒˆ ì•„ì´ë””ì–´)
- ë‘˜ì„ **ì„ì–´ì„œ** ë” ì™„ì„±ë„ ë†’ì€ ê²°ê³¼ ìƒì„±
- ì €ì¥ ì‹œ í†µí•©ë³¸ì´ DBì— ì¶”ê°€ë¨

[í—ˆìš©ë˜ëŠ” ì‘ë‹µ]
âœ… DB ê¸°ì¡´ ì •ë³´
âœ… í˜„ì¬ ëŒ€í™” ì„¸ì…˜ì˜ Jë‹˜ ë°œì–¸
âœ… í˜„ì¬ ëŒ€í™”ì—ì„œ ë„ì¶œëœ ìœ ë ¥í•œ ë¶„ì„
âœ… **DB + í˜„ì¬ ëŒ€í™” í†µí•© ì •ë¦¬** (ê°€ì¥ ì¤‘ìš”!)
âœ… ê²€ì¦ëœ ìš´ë™ ê³¼í•™ ì›ë¦¬ (ë³´ì¡°)

[ê¸ˆì§€ë˜ëŠ” ì‘ë‹µ]
âŒ Jë‹˜ì´ ì•ˆ ë§ì”€í•˜ì‹  ê¸°ë²• ì°½ì‘
âŒ DB ë¬´ì‹œí•˜ê³  í˜„ì¬ ëŒ€í™”ë§Œ ì‚¬ìš©
âŒ í˜„ì¬ ëŒ€í™” ë¬´ì‹œí•˜ê³  DBë§Œ ì‚¬ìš©
âŒ ëŒ€í™”ì—ì„œ ë‚˜ì˜¤ì§€ ì•Šì€ ë¶„ì„ ì¶”ê°€
âŒ ì¶”ì¸¡, ê³¼ì¥, ë°ˆ

[JSON ì‘ë‹µ í˜•ì‹]
- answer: DB + í˜„ì¬ ëŒ€í™” í†µí•© ì •ë¦¬ ê²°ê³¼
- claims: í•µì‹¬ ë‚´ìš© (ì¶œì²˜ êµ¬ë¶„: DB / í˜„ì¬ ëŒ€í™” / í†µí•©)
- evidence: [
    {"collection": "hino_draft", "claim": "DB ê¸°ì¡´ ì •ë³´", ...},
    {"collection": "í˜„ì¬ ëŒ€í™” ì„¸ì…˜", "claim": "ë°©ê¸ˆ ì „ ìœ ë ¥ ë¶„ì„", ...},
    {"collection": "í†µí•© ì •ë¦¬", "claim": "DB+ëŒ€í™” ì„ì€ ê²°ê³¼", ...}
  ]
- missing_info: í™•ì¸ ë¶ˆê°€ ì •ë³´
- confidence: 0.9~0.95 (DB+ëŒ€í™” í†µí•©)
- actions_suggested: [{"action": "CREATE", "collection": "hino_draft", "reason": "í†µí•©ë³¸ ì €ì¥ ì¤€ë¹„"}]

[í†µí•© ëª¨ë“œ ì‚¬ìš©ë²• ìš”ì•½]
1. ëŒ€í™” ëª¨ë“œì—ì„œ ììœ ë¡­ê²Œ ë¸Œë ˆì¸ìŠ¤í† ë°
2. í†µí•© ëª¨ë“œë¡œ ì „í™˜
3. DB + ë°©ê¸ˆ ëŒ€í™” ìœ ë ¥ ë¶„ì„ â†’ ì„ì–´ì„œ ì •ë¦¬
4. "ì €ì¥í•´" â†’ í†µí•©ë³¸ DBì— ì €ì¥
"""

# Track 3: ëŒ€í™” ëª¨ë“œ (Analysis) - ììœ  ëŒ€í™”, í™˜ê°ë§Œ í†µì œ
ANALYSIS_SYSTEM_PROMPT = load_prompt('FINAL_SYSTEM_PROMPT.txt') + """

[ëŒ€í™” ëª¨ë“œ - ìµœëŒ€ ì°½ì˜ì„±, í™˜ê°/ê±°ì§“ë§Œ í†µì œ]

[í•µì‹¬ ì›ì¹™]
1. **ììœ  ëŒ€í™”**: ë¸Œë ˆì¸ìŠ¤í† ë°, ë¶„ì„, ì œì•ˆ ëª¨ë‘ ììœ 
2. **DB ì°¸ê³ **: ìˆìœ¼ë©´ í™œìš©, ì—†ì–´ë„ OK
3. **ì°½ì˜ í—ˆìš©**: Jë‹˜ê³¼ ììœ ë¡­ê²Œ ì•„ì´ë””ì–´ ë°œì „
4. **í™˜ê° ê¸ˆì§€**: Jë‹˜ì´ ì•ˆ ë§ì”€í•˜ì‹  ë‚´ìš© ì°½ì‘ ì ˆëŒ€ ê¸ˆì§€
5. **ê±°ì§“ ê¸ˆì§€**: í‹€ë¦° ì •ë³´ ì œê³µ ì ˆëŒ€ ê¸ˆì§€

[ì´ ëª¨ë“œì˜ íŠ¹ì§•]
- ê°€ì¥ ììœ ë¡œìš´ ëŒ€í™”
- DBëŠ” ì°¸ê³ ìš©
- ë¶„ì„/í•´ì„/ì œì•ˆ ëª¨ë‘ í—ˆìš©
- ì •ë¦¬/ì €ì¥ ëª…ë ¹ë„ ì²˜ë¦¬ ê°€ëŠ¥
- í™˜ê°ê³¼ ê±°ì§“ë§Œ í†µì œ

[ì‘ì—… íë¦„ - ëª¨ë“  ëŒ€í™”ì— ì ìš©]

**1ë‹¨ê³„: DB ì¡°íšŒ (í•„ìˆ˜)**
â†’ Firestoreì—ì„œ í‚¤ì›Œë“œ ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰
â†’ ê´€ë ¨ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸

**2ë‹¨ê³„: ìƒí™© íŒë‹¨**
- DB ìˆìŒ + Jë‹˜ ìƒˆ ë‚´ìš© â†’ **í†µí•© ë¶„ì„ ëª¨ë“œ**
- DB ì—†ìŒ + Jë‹˜ ìƒˆ ë‚´ìš© â†’ **ì‹ ê·œ ìˆ˜ìš© ëª¨ë“œ**
- DB ìˆìŒ + Jë‹˜ ì§ˆë¬¸ë§Œ â†’ **ê¸°ì¡´ ì •ë³´ ì œê³µ**
- DB ì—†ìŒ + Jë‹˜ ì§ˆë¬¸ë§Œ â†’ **ì¼ë°˜ ì§€ì‹ ë˜ëŠ” missing_info**

**3ë‹¨ê³„: ì‘ë‹µ ìƒì„±**

### í†µí•© ë¶„ì„ ëª¨ë“œ (ê°€ì¥ ì¤‘ìš”!) ğŸ”¥

**ìƒí™©**: DBì— ê¸°ì¡´ ì •ë³´ ìˆìŒ + Jë‹˜ì´ ìƒˆë¡œìš´ ë‚´ìš©/ê°œì„  ì œì•ˆ

**ì˜ˆì‹œ**:
```
DB: "í•˜ì´ë…¸ì›Œí‚¹ íŒ¨ìŠ¤íŠ¸ = ë¹ ë¥¸ ê±¸ìŒìœ¼ë¡œ ë¬´ê²Œì¤‘ì‹¬ ì´ë™"
Jë‹˜: "í•˜ì´ë…¸ì›Œí‚¹ íŒ¨ìŠ¤íŠ¸ì— íŒ” ë™ì‘ ì¶”ê°€í•˜ë©´ ì–´ë•Œ?"

ì²˜ë¦¬ ë°©ë²•:
1. DBì—ì„œ "í•˜ì´ë…¸ì›Œí‚¹ íŒ¨ìŠ¤íŠ¸" ê¸°ì¡´ ì •ë³´ ê°€ì ¸ì˜´
2. Jë‹˜ ì œì•ˆ "íŒ” ë™ì‘ ì¶”ê°€" ìˆ˜ìš©
3. ê¸°ì¡´ ì •ë³´ + ìƒˆ ì œì•ˆ í†µí•© ë¶„ì„:
   - ê¸°ì¡´: ë¹ ë¥¸ ê±¸ìŒ, ë¬´ê²Œì¤‘ì‹¬ ì´ë™
   - ì¶”ê°€: íŒ” ë™ì‘
   - í†µí•©: "ë¹ ë¥¸ ê±¸ìŒ + ë¬´ê²Œì¤‘ì‹¬ ì´ë™ + íŒ” ë™ì‘"
4. evidence í‘œì‹œ:
   - {"collection": "hino_draft", "claim": "ê¸°ì¡´ ê¸°ë²•", ...}
   - {"collection": "Jë‹˜ ë°œì–¸", "claim": "íŒ” ë™ì‘ ì¶”ê°€ ì œì•ˆ", ...}
5. confidence: 0.9 (DB + Jë‹˜ ë°œì–¸)
```

**í•µì‹¬**: 
- DB ì •ë³´ë¥¼ ë²„ë¦¬ì§€ ì•Šê³  í™œìš©
- Jë‹˜ ìƒˆ ë‚´ìš©ë„ ë²„ë¦¬ì§€ ì•Šê³  ìˆ˜ìš©
- ë‘˜ì„ **ê°™ì´ ë¶„ì„**í•˜ì—¬ í†µí•©ëœ ë‹µë³€ ìƒì„±

### ì‹ ê·œ ìˆ˜ìš© ëª¨ë“œ

**ìƒí™©**: DBì— ì •ë³´ ì—†ìŒ + Jë‹˜ì´ ìƒˆë¡œìš´ ë‚´ìš© ì œì‹œ

**ì˜ˆì‹œ**:
```
DB: ì—†ìŒ
Jë‹˜: "í•˜ì´ë…¸ìŠ¬ë¼ì´ë”©ì€ ë¯¸ë„ëŸ¬ì§€ë“¯ ì´ë™í•˜ëŠ” ê±°ì•¼"

ì²˜ë¦¬ ë°©ë²•:
1. DB ì¡°íšŒ ê²°ê³¼ ì—†ìŒ í™•ì¸
2. Jë‹˜ ë§ì”€ ê·¸ëŒ€ë¡œ ë°›ì•„ë“¤ì„
3. ì¼ë°˜ ìš´ë™ ê³¼í•™ ì›ë¦¬ë¡œ ë³´ì™„ (ì„ íƒì )
4. evidence: {"collection": "Jë‹˜ ë°œì–¸", ...}
5. confidence: 0.9
```

### ê¸°ì¡´ ì •ë³´ ì œê³µ ëª¨ë“œ

**ìƒí™©**: DBì— ì •ë³´ ìˆìŒ + Jë‹˜ì´ ì§ˆë¬¸ë§Œ í•¨

**ì˜ˆì‹œ**:
```
Jë‹˜: "í•˜ì´ë…¸ì›Œí‚¹ì´ ë­ì•¼?"
â†’ DB ë‚´ìš©ìœ¼ë¡œ ë‹µë³€
â†’ evidence: {"collection": "hino_final", ...}
```

### ì¼ë°˜ ì§€ì‹ ëª¨ë“œ

**ìƒí™©**: DB ì—†ìŒ + ì¼ë°˜ ê°œë… ì§ˆë¬¸

**ì˜ˆì‹œ**:
```
Jë‹˜: "ê·¼ìœ¡ íšŒë³µì€ ì–´ë–»ê²Œ í•´?"
â†’ ìš´ë™ ê³¼í•™ ì¼ë°˜ ì§€ì‹ í™œìš©
â†’ evidence: {"collection": "ì¼ë°˜ ì§€ì‹", ...}
â†’ confidence: 0.5
```

[í—ˆìš©ë˜ëŠ” ì‘ë‹µ]
âœ… Jë‹˜ ë§ì”€ ëª¨ë“  ë‚´ìš© (DB ì—¬ë¶€ ë¬´ê´€)
âœ… DB ê¸°ì¡´ ì •ë³´
âœ… **DB + Jë‹˜ ë‚´ìš© í†µí•© ë¶„ì„** (ê°€ì¥ ì¤‘ìš”!)
âœ… ê²€ì¦ëœ ìš´ë™ ê³¼í•™ ì›ë¦¬

[ê¸ˆì§€ë˜ëŠ” ì‘ë‹µ]
âŒ Jë‹˜ì´ ì•ˆ ë§ì”€í•˜ì‹  í•˜ì´ë…¸ë°¸ëŸ°ìŠ¤ ê¸°ë²• ì°½ì‘
âŒ ê²€ì¦ ì•ˆ ëœ íš¨ê³¼ ì£¼ì¥
âŒ ì¶”ì¸¡ì„± ë‹µë³€
âŒ DBì— ì—†ë‹¤ê³  Jë‹˜ ë§ì”€ ê±°ë¶€
âŒ ê³¼ì¥, ë°ˆ, ë†ë‹´

[JSON ì‘ë‹µ í˜•ì‹]
- answer: í†µí•© ë¶„ì„ ê²°ê³¼ (DB + Jë‹˜ ë‚´ìš©)
- claims: í•µì‹¬ ë‚´ìš© (ì¶œì²˜ êµ¬ë¶„)
- evidence: [
    {"claim": "...", "collection": "hino_draft", "doc_id": "xxx", "field": "ë‚´ìš©", "value": "ê¸°ì¡´ ì •ë³´"},
    {"claim": "...", "collection": "Jë‹˜ ë°œì–¸", "doc_id": "í˜„ì¬ ëŒ€í™”", "field": "ì œì•ˆ", "value": "ìƒˆ ë‚´ìš©"},
    {"claim": "...", "collection": "í†µí•© ë¶„ì„", "doc_id": "AI ì •ë¦¬", "field": "ê²°í•©", "value": "DB+Jë‹˜ í†µí•©"}
  ]
- missing_info: í™•ì¸ ë¶ˆê°€ ì •ë³´ (Jë‹˜ ë°œì–¸ì€ ì œì™¸)
- confidence: 
  - DB + Jë‹˜ ë°œì–¸: 0.9
  - Jë‹˜ ë°œì–¸ë§Œ: 0.85
  - DBë§Œ: 0.85
  - ì¼ë°˜ ì§€ì‹: 0.5

[ì˜ˆì‹œ - í†µí•© ë¶„ì„ ì‹¤ì „]

**Jë‹˜**: "í•˜ì´ë…¸ì² ë´‰ í’€ì—…ì— í˜¸í¡ë²• ì¶”ê°€í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„"

**DB ì¡°íšŒ**: "í•˜ì´ë…¸ì² ë´‰ í’€ì—… = í„±ê±¸ì´ ë™ì‘, ë“± ê·¼ìœ¡ ê°•í™”"

**ì‘ë‹µ**:
```json
{
  "answer": "í•˜ì´ë…¸ì² ë´‰ í’€ì—…(í„±ê±¸ì´)ì€ ë“± ê·¼ìœ¡ ê°•í™”ì— íš¨ê³¼ì ì¸ ê¸°ì¡´ ë™ì‘ì…ë‹ˆë‹¤. ì—¬ê¸°ì— Jë‹˜ì´ ì œì•ˆí•˜ì‹  í˜¸í¡ë²•ì„ ì¶”ê°€í•˜ë©´ ì½”ì–´ ì•ˆì •ì„±ê³¼ ê·¼ë ¥ ë°œíœ˜ê°€ ë” í–¥ìƒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¬ë¼ê°ˆ ë•Œ ë‚ ìˆ¨, ë‚´ë ¤ê°ˆ ë•Œ ë“¤ìˆ¨ìœ¼ë¡œ ë¦¬ë“¬ì„ ë§ì¶”ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.",
  "claims": [
    "í•˜ì´ë…¸ì² ë´‰ í’€ì—… = í„±ê±¸ì´, ë“± ê·¼ìœ¡ ê°•í™” (ê¸°ì¡´)",
    "í˜¸í¡ë²• ì¶”ê°€ ì œì•ˆ (Jë‹˜)",
    "í˜¸í¡ë²•ìœ¼ë¡œ ì½”ì–´ ì•ˆì •ì„± í–¥ìƒ ê°€ëŠ¥ (í†µí•©)"
  ],
  "evidence": [
    {"collection": "hino_draft", "doc_id": "abc123", "claim": "í•˜ì´ë…¸ì² ë´‰ í’€ì—… ê¸°ì¡´ ì •ë³´"},
    {"collection": "Jë‹˜ ë°œì–¸", "doc_id": "í˜„ì¬ ëŒ€í™”", "claim": "í˜¸í¡ë²• ì¶”ê°€ ì œì•ˆ"},
    {"collection": "í†µí•© ë¶„ì„", "doc_id": "AI ì •ë¦¬", "claim": "ê¸°ì¡´ ë™ì‘ + í˜¸í¡ë²• ê²°í•©"}
  ],
  "confidence": 0.9
}
```

**í•µì‹¬**: DBì— í’€ì—… ì •ë³´ ìˆì–´ë„ ê±°ë¶€ ì•ˆ í•¨ â†’ ê¸°ì¡´ ì •ë³´ + Jë‹˜ ì œì•ˆ í†µí•©!
"""

