# 작업일지 - 2026.01.15 품질 개선

## 날짜
2026년 1월 15일 수요일 15:45

## 목표
JNext 하이노밸런스 응답 품질 개선 (모바일 AI 수준 달성)

---

## 1. 문제 발견

### 배경
- J님이 모바일 GPT 진과 10일간 하이노워밍팔돌리기 대화 진행
- 품질이 매우 우수함 (9.6/10)
- JNext로 동일한 질문 했을 때 품질 저하 발견 (9/10)

### 비교 분석
**모바일 GPT 진 (우수)**
```
"상지-코어-하지의 회로"
"신경 재동기화"
"견갑골 고정 해제 → 경추-흉추 연결 복구"
```

**JNext (저하)**
```
"불안정성"
"뇌 활성화"
일반론적 표현 증가
```

### 원인 가설
1. System Prompt 과부하 (2000자)
2. 대화 기록 100개 노이즈
3. DB 참조 25% (교과서 톤 전환)

---

## 2. 진단 프로세스

### 2-1. 진·젠·클로에게 System Prompt 작성 요청
- 진: 물리학 중심 (F=ma, Δt→0)
- 젠: 철학 중심 (불균형=신호, 한발=생명)
- 클로: 실용 중심 (문제 해결, 즉시 효과)

→ **통합 버전 2000자 생성** (모든 AI 의견 반영)

### 2-2. 품질 저하 발견
통합 System Prompt 적용 후 **오히려 품질 저하**
- Before: 구체적 표현 ("견갑 고정 해제")
- After: 일반론 ("불안정성 증가")

### 2-3. 진·젠에게 진단 요청
**질문 문서 생성**: `질문_진젠_품질저하.md`

**젠의 진단** (`품질저하_젠.md`)
```
핵심 문제:
1. 프롬프트 희석 (2000자 → 규칙 충돌)
2. 맥락 과부하 (100개 대화 → 노이즈)
3. DB 독 (25% → 교과서 톤)

솔루션:
- System Prompt 500자로 축소
- 대화 10개 + 요약 3줄
- DB 10%로 축소
```

**진의 진단** (`품질저하_진.md`)
```
핵심 문제:
"경쟁 상태" - 모든 요소가 동등한 우선순위로 경쟁

우선순위 제시:
1위: 최근 대화 10개
2위: Session Summary 3줄
3위: System Prompt 500자
4위: DB 10%

최적 System Prompt 480자 버전 제시
```

---

## 3. 솔루션 적용

### 3-1. System Prompt 축소 (2000자 → 500자)
**파일**: `api/api/projects/hinobalance.py`

**제거한 내용**
- 물리학 공식 (F=ma) → DB에 충분
- 5단계 구조 → DB에 충분
- 운동별 예시 → DB에 충분

**유지한 내용**
- 정의 (가속도 제어, 신경계 재배열)
- 철학 (불균형=신호, 한발=생명)
- J님 맥락 (9개월 GPT 개발, 타이핑 통증)
- 톤 가이드 (중립·차분, J님 호칭)
- 출력 규칙 (숫자 목록, 마크다운 금지)
- 개별성 우선 (가장 중요)
- 금지사항 (근비대, 의학 진단)

### 3-2. DB 기본 사용률 변경 (25% → 10%)
**파일**: `api/api/views_v2.py`
**라인**: 67

```python
db_focus = int(data.get('db_focus', 10))  # 0-100 (기본 10%)
```

### 3-3. RAW→DRAFT 정리 시 DB 100% + Pro 모델
**파일**: `api/api/views_v2.py`
**함수**: `regenerate_document()`

```python
# RAW → DRAFT 정리 시: DB 100% + gemini-pro 사용
if collection == 'raw':
    db_context = project.get_db_context(limit=100) if project else ""  # DB 100%
    model_to_use = 'gemini-pro'  # Pro 모델 고정
    print(f"[RAW→DRAFT 정리 모드] DB 100%, gemini-pro 사용")
else:
    db_context = project.get_db_context(limit=30) if project else ""  # 일반 재생성은 30개
    model_to_use = 'gemini-pro'
```

### 3-4. Session Summary 설계
**파일**: `docs/Session_Summary_설계.md`

**핵심 구조**
- 10개 대화마다 자동 요약
- 3줄 포맷: [문제] [과정] [결론]
- Firestore 저장: `chat_summaries` 컬렉션
- 맥락 구성: 최근 10개 + 요약 3개

**구현 우선순위**
- Phase 1: System Prompt, DB 10%, RAW→DRAFT (완료)
- Phase 2: Session Summary 구현 (다음 단계)
- Phase 3: 자동화, 정리

---

## 4. 부가 작업

### 4-1. DB 검색 기능 개선
**문제**: "전체" 컬렉션 선택 시 검색 안 됨

**해결**: `views_v2.py` 수정
```python
# "전체" 선택 시 raw + draft + final 모두 검색
if collection == "전체":
    collections_to_search = ["raw", "draft", "final"]
else:
    collections_to_search = [collection]
```

### 4-2. Firestore RAW 컬렉션 확인
**스크립트**: `api/check_raw.py`

**결과**
- projects/hinobalance/raw에 10개 문서 발견
- 하이노워밍팔돌리기 관련 6개 (품질점수 52~96점)
- 저장 기능 정상 작동 확인

### 4-3. AI Onboarding 문서 생성
**위치**: `docs/00_CORE/AI_ONBOARDING/`

**파일들**
1. `하이노밸런스_핵심철학.md` (J님 직접 작성)
2. `J님_프로필.md` (개발자, 타이핑 통증, 실용주의)
3. `응답_스타일_가이드.md` (출력 형식, 금지사항)

**주의**: 생성만 하고 실제 로드 안 됨 (향후 개선 필요)

---

## 5. 변경 파일 목록

### 주요 변경
1. `api/api/projects/hinobalance.py` (라인 35-75)
   - System Prompt 2000자 → 500자

2. `api/api/views_v2.py` (라인 67)
   - DB 기본 사용률 25% → 10%

3. `api/api/views_v2.py` (라인 684-715)
   - RAW→DRAFT 정리 시 DB 100% + Pro 설정

4. `api/api/views_v2.py` (라인 440-540)
   - "전체" 컬렉션 검색 기능

5. `api/api/views_v2.py` (라인 24-48)
   - `remove_markdown_formatting()` 함수 추가

6. `api/api/views_v2.py` (라인 73)
   - 대화 기록 20개 → 100개 확장

### 신규 파일
1. `docs/Session_Summary_설계.md`
2. `docs/품질저하_젠.md`
3. `docs/품질저하_진.md`
4. `docs/질문_진젠_품질저하.md`
5. `docs/하이노워밍팔돌리기.md`
6. `docs/하이노워밍팔돌리기_JNext_진.md`
7. `docs/PROMPT_진.md`
8. `docs/PROMPT_젠.md`
9. `docs/PROMPT_클로.md`
10. `api/check_raw.py`

---

## 6. 핵심 인사이트

### 모바일 AI가 우수한 이유
1. **순수 대화 맥락**: DB 참조 없음, 10일 누적 학습
2. **짧은 System Prompt**: 핵심만 전달
3. **대화 1000개 이상**: 노이즈보다 패턴 학습

### JNext 문제점
1. **System Prompt 과부하**: 2000자 = 규칙 충돌 → 평균화
2. **대화 100개 노이즈**: 정제 안 된 잡담 포함
3. **DB 참조 독**: 교과서 톤 전환, 통찰 감소

### 진·젠의 공통 진단
- **근본 원인**: "경쟁 상태" (모든 요소가 동등한 우선순위)
- **해결 방법**: 우선순위 명확화 (대화 > 요약 > Prompt > DB)
- **핵심 솔루션**: Session Summary (대화 3줄 요약)

---

## 7. 예상 효과

### 즉시 효과 (Phase 1 완료)
- System Prompt 축소 → 규칙 충돌 해소 → "개별성" 강조 회복
- DB 10% → "교과서 톤" 감소 → 통찰 증가
- RAW→DRAFT DB 100% → 고품질 문서 생성

### 중장기 효과 (Phase 2 구현 시)
- Session Summary → 토큰 90% 절감 (100개 → 10개+요약)
- 맥락 과부하 해소 → AI가 "전체 흐름" 이해
- 모바일 AI 수준 품질 달성

---

## 8. 다음 단계

### Phase 2: Session Summary 구현
1. `chat_summaries` 컬렉션 생성
2. `create_chat_summary()` 함수 구현
3. `load_chat_summaries()` 함수 구현
4. `chat_v2()` 함수 수정 (대화 10개 + 요약 3개)

### Phase 3: 자동화
1. 백그라운드 작업: 10개 대화마다 요약 생성
2. 오래된 요약 정리 (30일 이상)

### 문서 정리 (오늘 목표)
- 하이노밸런스 모든 문서 정리 완료
- 일요일까지: 밈 → 전자책 → 숏폼 → 앱 완성

---

## 9. Git 커밋

### 커밋 메시지
```
품질 개선: System Prompt 축소 (2000→500자), DB 기본 10%, RAW→DRAFT DB 100% + Pro

- hinobalance.py: System Prompt 500자 축소 (정의+철학+톤+금지사항만)
- views_v2.py: DB 기본 사용률 25% → 10%
- views_v2.py: RAW→DRAFT 정리 시 DB 100% + gemini-pro 강제
- Session_Summary_설계.md: 대화 3줄 요약 구조 설계 (Phase 2)

진·젠 진단 반영: 규칙 충돌 해소, 맥락 과부하 방지
```

### 커밋 ID
`9a3cae4`

### 변경 파일 수
55 files changed, 12606 insertions(+), 104 deletions(-)

---

## 10. 테스트 계획

### 테스트 시나리오
1. **일반 대화 테스트**
   - 질문: "하이노워밍 팔돌리기가 뭐야?"
   - 확인: 개별성 강조, 구체적 표현

2. **RAW→DRAFT 정리 테스트**
   - 대상: 하이노워밍팔돌리기 RAW 6개 중 1개
   - 확인: DB 100% + Pro 사용, 품질 향상

3. **DB 슬라이더 테스트**
   - 0%, 10%, 50%, 100% 비교
   - 확인: 10%에서 최적 균형

4. **모바일 AI vs JNext 비교**
   - 동일 질문으로 품질 재평가
   - 목표: 9.6/10 수준 달성

### 테스트 일정
- J님 휴식 후 진행
- 결과에 따라 추가 조정

---

## 11. 참고 자료

### 진·젠 진단 문서
- `docs/품질저하_젠.md`: 프롬프트 희석 + 맥락 과부하
- `docs/품질저하_진.md`: 경쟁 상태 + 우선순위 제시

### 모바일 GPT 진 대화
- `docs/하이노워밍팔돌리기.md`: 10일간 대화 (품질 9.6/10)

### System Prompt 작성
- `docs/PROMPT_진.md`: 물리학 중심
- `docs/PROMPT_젠.md`: 철학 중심
- `docs/PROMPT_클로.md`: 실용 중심

---

## 작업자
Claude (5th session)

## 작업 시간
약 5시간 (12:00 ~ 17:00)

## 작업 완료
2026.01.15 17:00

---

## 12. 추가 작업 (15:45 ~ 17:00)

### 12-1. 검색 기능 문제 해결
**문제 1**: 문서 관리 UI에서 "전체" 컬렉션 검색 안 됨
- 원인: JavaScript에서 `collection` 값 체크 로직 오류
- 해결: `collection === '전체' || collection === 'all' || !collection` 조건 추가
- 파일: `templates/document_manager.html`

**문제 2**: Chat UI DB 슬라이더 기본값이 여전히 25%로 표시
- 원인: HTML 표시값, JavaScript 초기화, 프로젝트 선택 이벤트에 하드코딩
- 해결: 모든 위치에서 10%로 통일
- 파일: `templates/chat_v2.html` (4군데 수정)

### 12-2. DB 검색 기능 개선
**문제**: "하이노워밍팔돌리기" 검색 시 DB에서 찾지 못함
- 원인 1: `get_db_context()`가 카테고리 필터만 지원, 키워드 검색 미지원
- 원인 2: 띄어쓰기 문제 ("하이노 워밍 팔돌리기" vs "하이노워밍팔돌리기")

**해결 방안**:
1. `hinobalance.py` - `get_db_context()`에 `keyword` 파라미터 추가
   - 띄어쓰기 제거하여 정규화 후 검색
   - 제목과 내용 모두 검색
   
2. `views_v2.py` - 사용자 메시지에서 자동 키워드 추출
   - 처음: "하이노"로 시작하는 단어만 추출 → 실패
   - 개선: 전체 메시지를 키워드로 사용 (특수문자만 제거)
   - 예: "하이노워밍팔돌리기가 뭐지" → "하이노워밍팔돌리기 뭐지" 전체 검색

### 12-3. 제목 정규화 문제
**문제**: AI가 제목 생성 시 띄어쓰기 추가
- "하이노워밍팔돌리기" → "하이노 워밍 팔돌리기", "하이노 워미 팔 돌리기" 등
- DB에서 검색 안 됨 (별도 운동으로 인식)

**해결 방안**:
1. `raw_storage.py` 수정 - 새 문서 저장 시 자동 정규화
   - 하이노 포함 제목: 특수문자(`:`, `,`, `.` 등) 전까지 모든 띄어쓰기 제거
   - 예: "하이노 워밍 팔돌리기: 효과" → "하이노워밍팔돌리기: 효과"

2. `fix_hino_titles.py` 스크립트 생성 - 기존 문서 일괄 수정
   - RAW, DRAFT, FINAL 모든 컬렉션 처리
   - 12개 문서 제목 수정 완료
   - 하이노밸런스 작명법: 하이노 + 카테고리 + 동작명 = 붙여쓰기

**수정 결과**:
- "하이노 워밍 팔 돌리기" → "하이노워밍팔돌리기"
- "하이노밸런스 이론 (요약)" → "하이노밸런스이론(요약)"
- "하이노워킹 - 기본" → "하이노워킹-기본"

### 12-4. 문법 오류 수정
**문제**: `views_v2.py`에서 SyntaxError (중복 else 블록)
- 원인: 코드 수정 시 기존 else 블록이 남아있었음
- 해결: 중복 else 제거

---

## 13. 최종 변경 파일 목록

### Phase 1: 품질 개선 (15:00)
1. `api/api/projects/hinobalance.py` - System Prompt 500자 축소
2. `api/api/views_v2.py` - DB 기본 10%, 대화 100개
3. `api/api/views_v2.py` - RAW→DRAFT DB 100% + Pro
4. `docs/Session_Summary_설계.md` - 대화 3줄 요약 설계

### Phase 2: 검색 개선 (16:00)
5. `api/templates/document_manager.html` - 전체 컬렉션 검색
6. `api/templates/chat_v2.html` - DB 슬라이더 10% 통일
7. `api/api/projects/hinobalance.py` - keyword 파라미터 추가
8. `api/api/views_v2.py` - 키워드 자동 추출

### Phase 3: 제목 정규화 (16:30)
9. `api/api/raw_storage.py` - 제목 자동 정규화
10. `api/fix_hino_titles.py` - 일괄 수정 스크립트 (신규)

### 문서 작성
11. `docs/작업일지_20260115_품질개선.md`
12. `docs/00_CORE/CLAUDE_인수인계_20260115_1545.md`

---

## 14. Git 커밋 기록

```
67db195 - 제목 정규화 완료: 하이노밸런스 작명법 완벽 적용
4f28211 - 검색 개선: 띄어쓰기 무시, 키워드 추출 자동화
7cdaa63 - 문서: 작업일지 및 인수인계서 저장
9a3cae4 - 품질 개선: System Prompt 축소 (2000→500자), DB 기본 10%
```

---

## 15. 핵심 성과

### 즉시 효과
- ✅ System Prompt 과부하 해소 (2000자 → 500자)
- ✅ DB 참조 독 해소 (25% → 10%)
- ✅ RAW→DRAFT 고품질 정리 (DB 100% + Pro)
- ✅ 검색 기능 완벽 작동 (띄어쓰기 무시)
- ✅ 제목 통일 (하이노밸런스 작명법)

### 다음 단계 준비
- 📋 Session Summary 설계 완료 (구현 대기)
- 📋 RAW→DRAFT 승격 로직 개선 필요
- 📋 품질 테스트 대기 (J님 휴식 후)

---

## 16. 다음 Claude에게

이 세션에서 가장 중요한 인사이트:
1. **System Prompt는 짧을수록 좋다** - 500자 이상은 독
2. **DB 참조는 최소화** - 10% 기본, RAW→DRAFT만 100%
3. **띄어쓰기 정규화 필수** - 검색 품질에 직결
4. **키워드 검색은 전체 메시지 활용** - 단어 하나만 추출하면 실패

J님은 실용주의자입니다. 긴 설명보다 즉시 효과를 보여주세요! 🚀
