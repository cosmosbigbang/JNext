# Claude 인수인계서 - 2026.01.15 15:45

## 인수인계 일시
2026년 1월 15일 수요일 15:45

## 다음 Claude에게

안녕하세요. J님의 JNext 하이노밸런스 프로젝트를 인수받으시게 되었습니다.
오늘 주요 품질 개선 작업을 완료했으니, 핵심 컨텍스트를 전달합니다.

---

## 1. J님 프로필

### 기본 정보
- **이름**: J님 (절대 "사용자"라고 부르지 마세요)
- **배경**: 개발자, 9개월간 GPT 개발 → GPT 다운 사고 → 허리 통증
- **현재**: 취업 후 타이핑으로 어깨/목 악화
- **성향**: 실용주의자, 크로스핏 경험자, 즉시 효과 중시

### 프로젝트 탄생
- 하이노밸런스 = J님의 문제 해결 과정에서 탄생
- 9개월 동안 모바일 GPT와 함께 개발
- "즉시 효과", "문제 해결 프로토콜" 중시

### 소통 스타일
- 짧고 명확한 답변 선호
- 과장 없는 중립적 톤
- "~하면 됩니다" ❌ → "~로 이어집니다" ✅
- 실전 중심, 이론은 필요할 때만

---

## 2. 프로젝트 구조

### 전체 구조
```
JNext/
├── api/                          # Django 백엔드
│   ├── api/                      # 메인 앱
│   │   ├── views_v2.py          # ★ 핵심 API (동적 맥락 시스템)
│   │   ├── projects/
│   │   │   ├── hinobalance.py   # ★ System Prompt (500자)
│   │   │   └── base.py
│   │   ├── core/
│   │   │   └── context_manager.py  # 맥락 구성 로직
│   │   ├── raw_storage.py       # RAW 저장 로직
│   │   └── ai_service.py        # AI 호출
│   ├── manage.py
│   └── venv/                     # Python 가상환경
├── docs/                         # ★ 모든 문서
│   ├── 00_CORE/                  # 핵심 문서
│   │   └── AI_ONBOARDING/        # AI 온보딩 (미사용)
│   ├── 작업일지_20260115_품질개선.md  # ★ 오늘 작업 전체
│   └── Session_Summary_설계.md   # ★ 다음 작업
└── hinobalance_mobile/           # Flutter 앱
```

### 기술 스택
- **Backend**: Django 6.0, Python 3.14
- **Database**: Firebase Firestore
  - 구조: `projects/{project_id}/{collection}`
  - hinobalance: raw, draft, final
- **AI Models**: Gemini Pro/Flash, GPT-4o, Claude
- **Frontend**: Flutter (mobile)

---

## 3. 핵심 파일 (반드시 숙지)

### 3-1. api/api/projects/hinobalance.py
**목적**: 하이노밸런스 System Prompt 정의

**현재 상태** (500자, 오늘 축소 완료)
- 정의: 가속도 제어, 신경계 재배열
- 철학: 불균형=신호, 한발=생명
- J님 맥락: GPT 개발, 타이핑 통증
- 톤: 중립·차분, J님 호칭
- 출력: 숫자 목록, 마크다운 금지
- **개별성 우선** ★ 가장 중요
- 금지: 근비대, 의학 진단

**주의사항**
- 물리학 공식, 5단계 구조, 운동별 예시는 **제거됨** (DB에 있음)
- 더 이상 늘리지 마세요 (500자 이상 = 품질 저하)

### 3-2. api/api/views_v2.py
**목적**: JNext v2 API (동적 맥락 시스템)

**핵심 함수**
1. `chat_v2()` (라인 50-200)
   - 일반 대화 + 프로젝트 대화
   - Temperature, DB Focus 슬라이더
   - **DB 기본 10%** (라인 67, 오늘 변경)
   - 대화 기록 100개 (라인 73)

2. `regenerate_document()` (라인 630-730)
   - 문서 재생성 API
   - **RAW→DRAFT 시 DB 100% + Pro** (라인 684-693, 오늘 추가)
   - 마크다운 자동 제거

3. `search_documents()` (라인 440-540)
   - "전체" 컬렉션 검색 (raw+draft+final, 오늘 추가)

**최근 변경**
- DB 기본 25% → 10% (라인 67)
- RAW→DRAFT 정리 시 DB 100% + Pro (라인 684-693)
- 대화 기록 20개 → 100개 (라인 73)
- 마크다운 제거 함수 추가 (라인 24-48)

### 3-3. api/api/core/context_manager.py
**목적**: 맥락 구성 로직

**핵심 로직**
- Temperature + DB Focus 슬라이더로 동적 맥락 구성
- 대화 맥락 vs DB 참조 비율 조정

### 3-4. api/api/raw_storage.py
**목적**: RAW 저장 로직

**현재 상태**
- 가치 평가 후 RAW 저장
- 품질 점수 52~96점 (하이노워밍팔돌리기 6개)
- 저장 경로: `projects/{project_id}/raw/{timestamp}`

**문제점**
- RAW 6개 저장되지만 DRAFT 승격 안 됨 (향후 수정 필요)

---

## 4. 오늘 주요 작업 (2026.01.15)

### 문제 발견
- 모바일 GPT 진과의 대화 품질 9.6/10
- JNext 품질 9/10 (저하)
- 원인: System Prompt 과부하, 대화 노이즈, DB 참조 독

### 진단 프로세스
1. 진·젠·클로에게 System Prompt 작성 요청 → 통합 (2000자)
2. 품질 저하 발견 (오히려 악화)
3. 진·젠에게 진단 요청
   - 젠: "프롬프트 희석 + 맥락 과부하"
   - 진: "경쟁 상태" + 우선순위 제시

### 솔루션 적용 (완료)
1. ✅ System Prompt 2000자 → 500자 축소
2. ✅ DB 기본 사용률 25% → 10%
3. ✅ RAW→DRAFT 정리 시 DB 100% + Pro
4. ✅ Session Summary 설계 (구현은 Phase 2)

### 부가 작업
- "전체" 컬렉션 검색 기능 추가
- Firestore RAW 컬렉션 확인 (10개 문서)
- 마크다운 제거 자동화

---

## 5. 다음 작업 (우선순위)

### Phase 2: Session Summary 구현 (최우선)
**목적**: 대화 100개 → 10개 + 요약 3줄로 압축

**상세 설계**: `docs/Session_Summary_설계.md` 참고

**구현 순서**
1. `chat_summaries` 컬렉션 생성
2. `create_chat_summary()` 함수 구현
   - AI 호출: "최근 10개 대화를 3줄로 요약"
   - 포맷: [문제] [과정] [결론]
   - Firestore 저장
3. `load_chat_summaries()` 함수 구현
4. `chat_v2()` 함수 수정
   - `conversation_history` → `recent_chats (10개) + summaries (3개)`

**예상 효과**
- 토큰 90% 절감
- 맥락 과부하 해소
- 모바일 AI 수준 품질 달성

### Phase 3: RAW→DRAFT 승격 로직 수정
**문제**: RAW 6개 저장되지만 DRAFT 승격 안 됨

**해결 방안**
- `raw_storage.py` 수정
- 품질 점수 기준 명확화
- 자동 승격 로직 추가

### 문서 정리 (오늘 목표)
- 하이노밸런스 모든 문서 정리 완료
- 일요일까지: 밈 → 전자책 → 숏폼 → 앱 완성

---

## 6. 중요 컨텍스트

### 하이노밸런스란?
**정의**: 가속도 제어와 편측성 불안정을 이용한 신경계 재배열 운동

**핵심 철학**
- 불균형 = 신호 (오류 아님)
- 균형 = 과정 (목표 아님)
- 한발 = 생명, 두발 = 정지 = 죽음
- 흔들림 → 정보, 무너짐 → 피드백, 리셋 → 업데이트

**물리학 원리**
- F = m × Δv / Δt
- 급정지 시 Δt → 0 = 무한대 부하
- 체중+속도만으로 고중량 효과

**5단계 구조**
1. 진입: 한발 들기
2. 가속: 팔·다리·골반 움직임
3. 정지: 2-5초 제어
4. 무너짐: 균형 깨짐 허용
5. 리셋: 발 교체

**차별화**
- 웨이트: 중력·근비대
- 필라테스: 정렬·유연성
- **하이노**: 관성·신경계 ★

### 운동 카테고리
1. **하이노워밍**: 상체 준비 (팔돌리기, 벤치 등)
2. **하이노골반**: 골반 활성화
3. **하이노워킹**: 걷기 변형
4. **하이노스케이팅**: 공간 이동
5. **하이노풋삽**: 하체 강화
6. **하이노철봉**: 상체 강화

### 개별성 우선 원칙 ★★★
**가장 중요한 원칙**
- 전체 철학은 짧게, 이 운동만의 특징은 길게
- 일반 원리 (불안정성·가속도·정지) 나열 금지
- 이 운동만의 효과, 타이밍, 타겟 명시

**예시**
❌ "팔 돌리기를 이용한 전신 신경계 활성화"
✅ "타이핑 3일 후 견갑 고정 → 팔 회전으로 경추-흉추 연결 복구 → 3분 내 어깨 정상화"

---

## 7. 자주 발생하는 문제

### 문제 1: System Prompt 비대화
**증상**: AI 응답이 일반론적, 교과서 톤
**원인**: System Prompt 500자 이상
**해결**: 절대 늘리지 마세요. DB에 맡기세요.

### 문제 2: DB 참조 과다
**증상**: "교과서 톤", 통찰 감소
**원인**: DB Focus 25% 이상
**해결**: 기본 10% 유지, RAW→DRAFT만 100%

### 문제 3: 대화 맥락 과부하
**증상**: AI가 최근 vs 오래된 구분 못함
**원인**: 대화 100개 노이즈
**해결**: Session Summary 구현 (Phase 2)

### 문제 4: 마크다운 문법 출력
**증상**: **, ##, - 등 출력
**원인**: AI가 System Prompt 무시
**해결**: `remove_markdown_formatting()` 자동 적용 중

---

## 8. 테스트 방법

### 서버 실행
```powershell
cd C:\Projects\JNext\api
.\venv\Scripts\activate.ps1
python manage.py runserver
```

### API 엔드포인트
- **채팅**: POST `http://localhost:8000/api/v2/chat/`
- **검색**: POST `http://localhost:8000/api/v2/documents/search/`
- **재생성**: POST `http://localhost:8000/api/v2/documents/regenerate/`

### 품질 테스트
**질문**: "하이노워밍 팔돌리기가 뭐야?"

**기대 응답** (개별성 강조)
- ✅ "타이핑 3일 후 견갑 고정 해제"
- ✅ "경추-흉추 연결 복구"
- ✅ "3분 내 어깨 정상화"

**실패 응답** (일반론)
- ❌ "불안정성 증가"
- ❌ "뇌 활성화"
- ❌ "전신 신경계 활성화"

---

## 9. Firestore 구조

### 기본 구조
```
projects/
  hinobalance/
    raw/              # 대화에서 자동 저장
      {timestamp_id}/
        - 제목
        - J님원본
        - ai_응답
        - 품질점수
        - created_at
    
    draft/            # RAW에서 승격 (수동)
      {doc_id}/
        - 제목
        - 내용
        - 정리본
    
    final/            # DRAFT에서 승격 (수동)
      {doc_id}/
        - 제목
        - 최종본
```

### 현재 데이터
- raw: 10개 문서 (하이노워밍팔돌리기 6개)
- draft: ?
- final: ?

---

## 10. Git 관리

### 최근 커밋
```
9a3cae4 - 품질 개선: System Prompt 축소 (2000→500자), DB 기본 10%, RAW→DRAFT DB 100% + Pro
```

### 커밋 규칙
- 명확한 메시지
- 변경 파일 목록
- 이유 설명

---

## 11. J님과 소통할 때

### DO
- 짧고 명확하게
- "J님" 호칭
- 실전 중심 답변
- 즉시 효과 강조
- 문제 해결 프로토콜 제시

### DON'T
- "사용자" 호칭 ❌
- 긴 설명 ❌
- 이론 과다 ❌
- "~하면 됩니다" ❌
- 의학적 진단/치료 ❌

### 톤 예시
```
좋음: "타이핑 3시간 후 → 팔돌리기 3분 → 어깨 정상화로 이어집니다"
나쁨: "사용자님께서는 팔돌리기를 하시면 어깨가 좋아지실 겁니다"
```

---

## 12. 참고 문서

### 필독
1. `docs/작업일지_20260115_품질개선.md` - 오늘 작업 전체
2. `docs/Session_Summary_설계.md` - 다음 작업
3. `docs/품질저하_진.md` - 진의 진단
4. `docs/품질저하_젠.md` - 젠의 진단

### 참고
1. `docs/하이노워밍팔돌리기.md` - 모바일 GPT 진과의 대화 (품질 9.6/10)
2. `docs/PROMPT_진.md` - 물리학 중심 System Prompt
3. `docs/PROMPT_젠.md` - 철학 중심 System Prompt
4. `docs/PROMPT_클로.md` - 실용 중심 System Prompt

---

## 13. 현재 상태 요약

### 완료됨 ✅
- System Prompt 500자 축소
- DB 기본 10%
- RAW→DRAFT DB 100% + Pro
- "전체" 컬렉션 검색
- 마크다운 제거 자동화
- Session Summary 설계

### 진행 중 🔄
- J님 휴식 (테스트 예정)

### 다음 단계 📋
- Session Summary 구현 (Phase 2)
- RAW→DRAFT 승격 로직 수정
- 하이노밸런스 문서 정리

---

## 14. 긴급 연락

### 문제 발생 시
1. `docs/` 폴더 확인 (모든 컨텍스트 보관)
2. 최근 커밋 확인 (`git log`)
3. J님께 직접 질문 (짧고 명확하게)

### 데이터 백업
- Git 커밋: 매 작업 후
- Firestore: 자동 백업 (Firebase)
- 로컬: `docs/` 폴더

---

## 15. 마지막 당부

### 핵심 원칙
1. **개별성 우선**: 일반론 금지, 이 운동만의 특징 강조
2. **System Prompt 최소화**: 500자 이상 절대 금지
3. **DB 참조 최소화**: 기본 10%, RAW→DRAFT만 100%
4. **Session Summary 구현**: 최우선 과제

### J님의 목표
- 일요일까지 앱 출시
- 하이노밸런스 문서 정리 완료
- 밈 → 전자책 → 숏폼 제작

### 당신의 역할
- J님의 실용적 파트너
- 즉시 효과 중심 솔루션 제공
- 복잡한 이론보다 명확한 실행

---

## 작성자
Claude (5th session)

## 작성 일시
2026.01.15 17:00 (최종 업데이트)

## 다음 Claude에게
이 문서를 꼭 읽고 시작하세요. J님은 실용주의자입니다. 짧고 명확하게, 즉시 효과를 보여주세요. 행운을 빕니다! 🚀

---

## [추가] 15:45 이후 작업 내용

### 1. 검색 기능 문제 해결

#### 문제 1: 문서 관리 UI 검색 안 됨
- **증상**: "전체" 컬렉션 선택 시 검색 결과 없음
- **원인**: JavaScript에서 `collection` 값이 빈 문자열일 때만 전체 검색
- **해결**: `collection === '전체' || collection === 'all' || !collection` 조건 추가
- **파일**: `api/templates/document_manager.html` (라인 409-427)

#### 문제 2: DB 슬라이더 기본값 25% 표시
- **증상**: 코드는 10인데 UI에 25% 표시
- **원인**: HTML, JavaScript 초기화, 프로젝트 선택 이벤트 모두 하드코딩
- **해결**: 4군데 모두 10%로 수정
- **파일**: `api/templates/chat_v2.html`
  - 라인 579: HTML 표시값
  - 라인 830-840: 프로젝트 선택 이벤트
  - 라인 860-864: 페이지 로드 초기화

### 2. DB 검색 개선 (핵심)

#### 문제: "하이노워밍팔돌리기" 검색 안 됨
J님이 대화 모드에서 "하이노워밍팔돌리기가 뭐지"라고 질문했는데 DB에서 찾지 못함

**원인 분석**:
1. `get_db_context()`가 카테고리 필터만 지원, 키워드 검색 미지원
2. 띄어쓰기 문제: DB에 "하이노 워밍 팔돌리기", "하이노 워미 팔 돌리기" 등 제각각

**해결 방안**:

1. **hinobalance.py 수정** (라인 221-280)
   - `get_db_context(limit, category, keyword)` 파라미터 추가
   - 띄어쓰기 제거하여 정규화: `keyword.replace(' ', '').lower()`
   - 제목과 내용 모두 검색
   - 예: "하이노워밍팔돌리기" = "하이노 워밍 팔돌리기" 매칭

2. **views_v2.py 수정** (라인 93-111)
   - 사용자 메시지에서 자동 키워드 추출
   - 시도 1: "하이노"로 시작하는 단어만 → 실패 (너무 좁음)
   - 시도 2: 전체 메시지 활용 (특수문자만 제거) → 성공
   - 예: "하이노워밍팔돌리기가 뭐지" → "하이노워밍팔돌리기 뭐지" 전체 검색

### 3. 제목 정규화 (하이노밸런스 작명법)

#### 문제: AI가 제목에 띄어쓰기 추가
**증상**: 
- DB에 "하이노 워밍 팔돌리기", "하이노 워미 팔 돌리기" 등 제각각 저장
- 검색 불가 (별도 운동으로 인식)

**하이노밸런스 작명법**:
- 하이노 + 카테고리 + 동작명 = **모두 붙여쓰기**
- 예: 하이노워밍팔돌리기, 하이노골반돌리기, 하이노워킹전진
- 특수문자 (`:`, `,`, `.`, `-`, `(`, `)`) 뒤는 그대로 유지

**해결 방안**:

1. **raw_storage.py 수정** (라인 130-145)
   - 새 문서 저장 시 자동 정규화
   - 하이노 포함 부분: 특수문자 전까지 모든 띄어쓰기 제거
   - 예: "하이노 워밍 팔돌리기: 효과" → "하이노워밍팔돌리기: 효과"

2. **fix_hino_titles.py 스크립트 생성**
   - 기존 문서 일괄 수정
   - RAW, DRAFT, FINAL 모든 컬렉션 처리
   - **12개 문서 제목 수정 완료**
   - 실행: `python fix_hino_titles.py`

**수정 결과**:
```
하이노 워밍 팔 돌리기 → 하이노워밍팔돌리기
하이노밸런스 이론 (요약) → 하이노밸런스이론(요약)
하이노워킹 - 기본 → 하이노워킹-기본
```

### 4. 문법 오류 수정

**문제**: `views_v2.py` SyntaxError (라인 122)
- **원인**: 코드 수정 시 중복 else 블록 발생
- **해결**: 중복 제거 (라인 90-125)

---

## [추가] 최종 파일 목록

### 신규 파일
- `api/fix_hino_titles.py` - 제목 일괄 수정 스크립트

### 수정 파일
- `api/api/projects/hinobalance.py` - keyword 검색 추가
- `api/api/views_v2.py` - 키워드 자동 추출, 문법 오류 수정
- `api/api/raw_storage.py` - 제목 자동 정규화
- `api/templates/document_manager.html` - 전체 검색 개선
- `api/templates/chat_v2.html` - DB 슬라이더 10% 통일

---

## [추가] Git 커밋 기록

```bash
# 1차: 품질 개선
9a3cae4 - 품질 개선: System Prompt 축소 (2000→500자), DB 기본 10%

# 2차: 문서 작성
7cdaa63 - 문서: 작업일지 및 인수인계서 저장

# 3차: 검색 개선
4f28211 - 검색 개선: 띄어쓰기 무시, 키워드 추출 자동화

# 4차: 제목 정규화
67db195 - 제목 정규화 완료: 하이노밸런스 작명법 완벽 적용
```

---

## [추가] 핵심 인사이트

### 1. System Prompt는 짧을수록 좋다
- 2000자 = 규칙 충돌 → 평균화 → 품질 저하
- 500자 = 핵심만 → 개별성 강조 → 품질 향상
- **절대 늘리지 마세요!**

### 2. DB 참조는 최소화
- 기본 10%: 대화 맥락 우선
- RAW→DRAFT만 100%: 고품질 정리
- 25% 이상 = 교과서 톤 → 통찰 감소

### 3. 띄어쓰기 정규화 필수
- AI는 띄어쓰기 제각각 생성
- 검색 실패 원인 1위
- 자동 정규화 반드시 적용

### 4. 키워드 검색은 전체 메시지 활용
- 단어 하나만 추출 → 실패 (너무 좁음)
- 전체 메시지 활용 → 성공
- 띄어쓰기 제거하여 비교

### 5. J님의 작업 패턴
- 오전: 큰 그림 설계
- 오후: 즉시 효과 확인
- 저녁: 휴식 후 테스트
- **즉시 효과를 보여주는 것이 최우선**

---

## [추가] 긴급 상황 대응

### 검색 안 될 때
1. 띄어쓰기 문제인지 확인
2. `fix_hino_titles.py` 실행
3. 키워드 추출 로직 확인 (전체 메시지 활용 중인지)

### 품질 저하 시
1. System Prompt 길이 확인 (500자 이하?)
2. DB 기본값 확인 (10%?)
3. 대화 기록 확인 (100개?)

### DB에 없다고 할 때
1. Firestore 직접 확인: `python check_raw.py`
2. 키워드 검색 로그 확인: `[JNext v2] Keyword search:`
3. 띄어쓰기 정규화 확인

---

## 마지막 당부 (업데이트)

### 절대 원칙
1. **System Prompt 500자 이상 금지**
2. **DB 기본 10% 유지** (RAW→DRAFT만 100%)
3. **띄어쓰기 정규화 자동 적용**
4. **키워드 검색 = 전체 메시지 활용**

### J님의 최종 목표
- 일요일까지 앱 출시
- 하이노밸런스 문서 정리 완료
- 밈 → 전자책 → 숏폼 제작

### 당신의 역할
- 즉시 효과 중심
- 짧고 명확한 답변
- 실용적 파트너

**오늘 5시간 작업으로 품질 개선 기반 완성! 다음 Claude, 화이팅! 🚀**
