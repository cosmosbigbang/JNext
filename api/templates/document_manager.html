<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JNext ë¬¸ì„œ ê´€ë¦¬</title>
    <!-- ì „ìì±… ì¶œíŒìš© í°íŠ¸ ì„í¬íŠ¸ (KoPub, ë³¸ëª…ì¡°/ë³¸ê³ ë”•) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.35);
            transform: translateY(-2px);
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, input {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border 0.3s;
        }

        select:focus, input:focus {
            border-color: #667eea;
        }

        button {
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button.secondary {
            background: #6c757d;
        }

        button.danger {
            background: #dc3545;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .document-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .doc-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            transition: all 0.2s;
        }

        .doc-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .doc-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .doc-info {
            flex: 1;
        }

        .doc-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .doc-title {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .doc-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-raw {
            background: #ffeaa7;
            color: #d63031;
        }

        .badge-draft {
            background: #74b9ff;
            color: #0984e3;
        }

        .badge-final {
            background: #00b894;
            color: white;
        }

        .doc-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .doc-preview {
            font-family: 'Noto Serif KR', serif;
            font-size: 14px;
            color: #555;
            line-height: 1.8;
            max-height: 60px;
            overflow: hidden;
        }

        .doc-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .doc-actions button {
            padding: 6px 15px;
            font-size: 12px;
        }

        .preview-panel {
            width: 700px;
            border-left: 1px solid #e0e0e0;
            background: #f8f9fa;
            overflow-y: auto;
            padding: 20px;
        }

        .preview-title {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: #222;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .preview-content {
            font-family: 'Noto Serif KR', serif;
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            font-size: 16px;
            line-height: 2.0;
            white-space: pre-wrap;
            color: #333;
            word-break: keep-all;
        }

        /* ì „ìì±… ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .preview-content img,
        img.ebook-image {
            max-width: 100%;
            height: auto;
        }
        
        /* float ì´ë¯¸ì§€ ë’¤ í…ìŠ¤íŠ¸ ì •ë¦¬ */
        .preview-content::after {
            content: "";
            display: table;
            clear: both;
        }

        /* ì´ë¯¸ì§€ ìº¡ì…˜ */
        .image-caption {
            font-style: italic;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #667eea;
        }

        /* textarea ì „ìì±… í°íŠ¸ ì ìš© */
        textarea {
            font-family: 'Noto Serif KR', serif;
            font-size: 16px;
            line-height: 2.0;
        }

        /* ì œëª© ìš”ì†Œ ì „ì²´ í°íŠ¸ ì ìš© */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>ğŸ“„ JNext ë¬¸ì„œ ê´€ë¦¬</span>
                <a href="/chat/v2" class="nav-btn">ğŸ’¬ ì±„íŒ…</a>
            </h1>
            <p>RAW/DRAFT/FINAL ë¬¸ì„œ ê²€ìƒ‰, ì„ íƒ, ì •ë¦¬, ì €ì¥</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>í”„ë¡œì íŠ¸:</label>
                <select id="project-select">
                    <option value="">ë¡œë”© ì¤‘...</option>
                </select>
            </div>

            <div class="control-group">
                <label>ì»¬ë ‰ì…˜:</label>
                <select id="collection-select">
                    <option value="">ì „ì²´</option>
                    <option value="raw">RAW</option>
                    <option value="draft">DRAFT</option>
                    <option value="final">FINAL</option>
                </select>
            </div>

            <div class="control-group">
                <label>ê²€ìƒ‰ íƒ€ì…:</label>
                <select id="search-type-select">
                    <option value="all">ì „ì²´</option>
                    <option value="category">ì¹´í…Œê³ ë¦¬</option>
                    <option value="exercise">ìš´ë™ëª…</option>
                    <option value="keyword">í‚¤ì›Œë“œ</option>
                </select>
            </div>

            <div class="control-group">
                <label>ê²€ìƒ‰ì–´:</label>
                <input type="text" id="keyword-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." onkeypress="if(event.key==='Enter') searchDocuments()">
                <button onclick="searchDocuments()">ğŸ” ê²€ìƒ‰</button>
            </div>

            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button onclick="selectAll()">âœ… ì „ì²´ ì„ íƒ</button>
                <button onclick="combineSelected()">ğŸ”„ ì„ íƒ ë¬¸ì„œ ì •ë¦¬</button>
                <button class="danger" onclick="deleteSelected()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
            </div>
        </div>

        <div class="main-content">
            <div class="document-list" id="document-list">
                <div class="loading">ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="preview-panel" id="preview-panel">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <p>ë¬¸ì„œë¥¼ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allDocuments = [];
        let selectedProject = 'hinobalance';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', async () => {
            await loadProjects();
            await searchDocuments();
        });

        // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
        async function loadProjects() {
            try {
                const response = await fetch('/api/v2/projects/');
                const data = await response.json();
                
                const select = document.getElementById('project-select');
                select.innerHTML = data.projects.map(proj =>
                    `<option value="${proj.id}" ${proj.id === 'hinobalance' ? 'selected' : ''}>${proj.name}</option>`
                ).join('');

                select.addEventListener('change', (e) => {
                    selectedProject = e.target.value;
                    searchDocuments();
                });
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë¬¸ì„œ ê²€ìƒ‰
        async function searchDocuments() {
            const collection = document.getElementById('collection-select').value;
            const searchType = document.getElementById('search-type-select').value;
            const keyword = document.getElementById('keyword-input').value.trim();

            const listDiv = document.getElementById('document-list');
            listDiv.innerHTML = '<div class="loading">ê²€ìƒ‰ ì¤‘...</div>';

            try {
                // "ì „ì²´" ì„ íƒ ì‹œ ë˜ëŠ” ë¹ˆ ê°’ì´ë©´ raw, draft, final ëª¨ë‘ ê²€ìƒ‰
                const collections = (collection === 'ì „ì²´' || collection === 'all' || !collection) 
                    ? ['raw', 'draft', 'final'] 
                    : [collection];
                const promises = collections.map(col => 
                    fetch(`/api/v2/documents/search/?project=${selectedProject}&collection=${col}&keyword=${encodeURIComponent(keyword)}&search_type=${searchType}`)
                        .then(r => r.json())
                        .then(data => data.documents || [])
                );

                const results = await Promise.all(promises);
                allDocuments = results.flat();

                displayDocuments(allDocuments);
            } catch (error) {
                console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                listDiv.innerHTML = '<div class="empty-state"><p>âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p></div>';
            }
        }

        // ë¬¸ì„œ ëª©ë¡ í‘œì‹œ
        function displayDocuments(documents) {
            const listDiv = document.getElementById('document-list');

            if (documents.length === 0) {
                listDiv.innerHTML = '<div class="empty-state"><p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }

            listDiv.innerHTML = documents.map((doc, index) => `
                <div class="doc-item">
                    <input type="checkbox" class="doc-checkbox" data-index="${index}">
                    <div class="doc-info">
                        <div class="doc-header">
                            <div class="doc-title">${doc.ì œëª© || 'ì œëª© ì—†ìŒ'}</div>
                            <span class="doc-badge badge-${doc.collection}">${doc.collection.toUpperCase()}</span>
                        </div>
                        <div class="doc-meta">
                            ìƒì„±: ${doc.ìƒì„±ì¼ || 'N/A'} | 
                            ëª¨ë¸: ${doc.aiëª¨ë¸ || 'N/A'} |
                            ${doc.í’ˆì§ˆì ìˆ˜ ? `í’ˆì§ˆ: ${doc.í’ˆì§ˆì ìˆ˜}ì ` : ''} 
                            ${doc.ê²€ì¦í•„ìš” ? 'âš ï¸' : ''}
                        </div>
                        <div class="doc-preview">${doc.ë‚´ìš©}</div>
                        <div class="doc-actions">
                            <button onclick="viewDocument(${index})">ğŸ‘ï¸ ë³´ê¸°</button>
                            <button onclick="editDocument(${index})">âœï¸ ìˆ˜ì •</button>
                            <button onclick="regenerate(${index})">ğŸ”„ ì¬ìƒì„±</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ë‚ ì§œ í¬ë§·
        function formatDate(date) {
            if (!date) return 'N/A';
            if (date._seconds) date = new Date(date._seconds * 1000);
            else if (typeof date === 'string') date = new Date(date);
            return date.toLocaleString('ko-KR');
        }

        // ì „ì²´ ì„ íƒ/í•´ì œ
        function selectAll() {
            const checkboxes = document.querySelectorAll('.doc-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        // ë¬¸ì„œ ë³´ê¸°
        function viewDocument(index) {
            const doc = allDocuments[index];
            const panel = document.getElementById('preview-panel');
            // ë””ë²„ê¹…: ì‹¤ì œ ë°ì´í„° í™•ì¸
            console.log('Doc data:', doc);
            
            // ë‚´ìš© ìš°ì„ ìˆœìœ„: ë‚´ìš©ì „ì²´ > ë‚´ìš©
            let fullContent = doc.ë‚´ìš©ì „ì²´ || doc.ë‚´ìš© || doc.content || 'ë‚´ìš© ì—†ìŒ';
            
            // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ë¥¼ HTMLë¡œ ë³€í™˜
            fullContent = convertMarkdownImagesToHtml(fullContent);
            
            panel.innerHTML = `
                <div class="preview-title">${doc.ì œëª© || doc.title || 'ì œëª© ì—†ìŒ'}</div>
                <div style="margin-bottom: 15px; font-size: 12px; color: #666;">
                    <strong>${doc.collection.toUpperCase()}</strong> | ${doc.ìƒì„±ì¼ || 'N/A'} | ${doc.aiëª¨ë¸ || 'N/A'}
                    ${doc.í’ˆì§ˆì ìˆ˜ ? `<br>í’ˆì§ˆ: ${doc.í’ˆì§ˆì ìˆ˜}ì ` : ''}
                    ${doc.ê²€ì¦í•„ìš” ? '<br>âš ï¸ ê²€ì¦ í•„ìš”' : ''}
                </div>
                ${doc.Jë‹˜ì›ë³¸ ? `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>ğŸ“Œ Jë‹˜ ì›ë³¸:</strong><br>
                        <pre style="white-space: pre-wrap; margin: 0;">${doc.Jë‹˜ì›ë³¸}</pre>
                    </div>
                ` : ''}
                <div class="preview-content">
                    <strong>ë‚´ìš©:</strong>
                    <div id="content-display" style="margin-top: 10px;">${fullContent}</div>
                </div>
                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                    <button onclick="enableEdit(${index})">âœï¸ ìˆ˜ì • ëª¨ë“œ</button>
                    <button onclick="regenerate(${index})" style="background: #28a745;">ğŸ”„ ì¬ìƒì„±</button>
                    <button onclick="showImageGenerator(${index})" style="background: #ff6b6b;">ğŸ¨ ì´ë¯¸ì§€ ìƒì„±</button>
                    ${doc.collection !== 'final' ? `<button onclick="moveToFinal(${index})" style="background: #007bff;">â¡ï¸ FINAL ì´ë™</button>` : ''}
                </div>
            `;
        }

        // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ë¥¼ HTMLë¡œ ë³€í™˜
        function convertMarkdownImagesToHtml(text) {
            if (!text) return '';
            
            // ![alt](url) í˜•ì‹ì„ <img> íƒœê·¸ë¡œ ë³€í™˜
            let result = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, url) => {
                return `<img src="${url}" alt="${alt}" class="ebook-image"><div class="image-caption">${alt}</div>`;
            });
            
            // ë‚˜ë¨¸ì§€ í…ìŠ¤íŠ¸ëŠ” ì¤„ë°”ê¿ˆ ìœ ì§€
            result = result.replace(/\n/g, '<br>');
            
            return result;
        }

        // ìˆ˜ì • ëª¨ë“œ í™œì„±í™”
        function enableEdit(index) {
            const doc = allDocuments[index];
            const panel = document.getElementById('preview-panel');
            
            // ëª¨ë“  ê°€ëŠ¥í•œ í•„ë“œ ì¶”ì¶œ
            const title = doc.ì œëª© || doc.title || doc.exercise_name || '';
            const content = doc.ë‚´ìš©ì „ì²´ || doc.ë‚´ìš© || doc.content || doc.final_refined || doc.refined || doc.organized_content || doc.ì •ë¦¬ë³¸ || doc.ai_ì‘ë‹µ || '';
            const original = doc.Jë‹˜ì›ë³¸ || doc.ì›ë³¸ || doc.original_content || doc.ì›ë³¸ì§ˆë¬¸ || '';
            const summary = doc.ìš”ì•½ || '';
            const keywords = doc.í‚¤ì›Œë“œ || '';
            const category = doc.ì¹´í…Œê³ ë¦¬ || doc.category || '';
            const aiModel = doc.aiëª¨ë¸ || '';
            const quality = doc.í’ˆì§ˆì ìˆ˜ || '';
            
            panel.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ì œëª©:</label>
                    <input type="text" id="edit-title" value="${title}" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë‚´ìš©:</label>
                    <textarea id="edit-content" rows="15" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px; font-family: monospace; resize: vertical;">${content}</textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Jë‹˜ ì›ë³¸:</label>
                    <textarea id="edit-original" rows="8" style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 8px; font-family: monospace; resize: vertical;">${original}</textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ìš”ì•½:</label>
                        <textarea id="edit-summary" rows="4" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px;">${summary}</textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">í‚¤ì›Œë“œ:</label>
                        <textarea id="edit-keywords" rows="4" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px;">${keywords}</textarea>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ì¹´í…Œê³ ë¦¬:</label>
                        <input type="text" id="edit-category" value="${category}" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">AI ëª¨ë¸:</label>
                        <input type="text" id="edit-ai-model" value="${aiModel}" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">í’ˆì§ˆì ìˆ˜:</label>
                        <input type="number" id="edit-quality" value="${quality}" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveEdit(${index})" style="flex: 1; background: #28a745;">ğŸ’¾ ì €ì¥</button>
                    <button onclick="viewDocument(${index})" style="flex: 1; background: #6c757d;">âŒ ì·¨ì†Œ</button>
                </div>
            `;
        }

        // ìˆ˜ì • ì €ì¥
        async function saveEdit(index) {
            const doc = allDocuments[index];
            const newTitle = document.getElementById('edit-title').value;
            const newContent = document.getElementById('edit-content').value;
            const newOriginal = document.getElementById('edit-original').value;
            const newSummary = document.getElementById('edit-summary').value;
            const newKeywords = document.getElementById('edit-keywords').value;
            const newCategory = document.getElementById('edit-category').value;
            const newAiModel = document.getElementById('edit-ai-model').value;
            const newQuality = document.getElementById('edit-quality').value;
            
            try {
                // ëª¨ë“  í•„ë“œëª…ì— ëŒ€í•´ ë™ì‹œ ì—…ë°ì´íŠ¸
                const updates = {
                    ì œëª©: newTitle,
                    title: newTitle,
                    exercise_name: newTitle,
                    ë‚´ìš©: newContent,
                    ë‚´ìš©ì „ì²´: newContent,
                    content: newContent,
                    final_refined: newContent,
                    refined: newContent,
                    organized_content: newContent,
                    ì •ë¦¬ë³¸: newContent,
                    ai_ì‘ë‹µ: newContent,
                    Jë‹˜ì›ë³¸: newOriginal,
                    ì›ë³¸: newOriginal,
                    original_content: newOriginal,
                    ì›ë³¸ì§ˆë¬¸: newOriginal,
                    ìš”ì•½: newSummary,
                    í‚¤ì›Œë“œ: newKeywords,
                    ì¹´í…Œê³ ë¦¬: newCategory,
                    category: newCategory,
                    aiëª¨ë¸: newAiModel,
                    í’ˆì§ˆì ìˆ˜: newQuality ? parseInt(newQuality) : null
                };
                
                const response = await fetch('/api/v2/documents/update/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project: selectedProject,
                        collection: doc.collection,
                        doc_id: doc.id,
                        updates: updates
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert('âœ… ì €ì¥ ì™„ë£Œ!');
                    searchDocuments();
                    // ì €ì¥ í›„ ë‹¤ì‹œ ë³´ê¸° ëª¨ë“œë¡œ
                    setTimeout(() => {
                        const newIndex = allDocuments.findIndex(d => d.id === doc.id);
                        if (newIndex >= 0) viewDocument(newIndex);
                    }, 500);
                } else {
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + (result.error || result.message));
                }
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                alert('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        // ë¬¸ì„œ ìˆ˜ì • (êµ¬ë²„ì „ - ì‚¬ìš© ì•ˆ í•¨)
        async function editDocument(index) {
            // ì´ì œ enableEdit ì‚¬ìš©
            enableEdit(index);
        }

        // ì¬ìƒì„±
        async function regenerate(index) {
            const doc = allDocuments[index];
            
            if (!confirm('ì´ ë¬¸ì„œë¥¼ AIë¡œ ì¬ìƒì„±í• ê¹Œìš”?\n\ní”„ë¡œì íŠ¸ ì „ì²´ ë§¥ë½ì„ í™œìš©í•˜ì—¬ ë” ì „ë¬¸ì ìœ¼ë¡œ ì¬ë¶„ì„í•©ë‹ˆë‹¤.')) return;
            
            const panel = document.getElementById('preview-panel');
            panel.innerHTML = '<div style="text-align: center; padding: 50px;">ğŸ”„ AIê°€ ì¬ìƒì„± ì¤‘ì…ë‹ˆë‹¤...<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>';
            
            try {
                const response = await fetch('/api/v2/documents/regenerate/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project: selectedProject,
                        collection: doc.collection,
                        doc_id: doc.id
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    // ì¬ìƒì„± ë¯¸ë¦¬ë³´ê¸° + í”¼ë“œë°± UI
                    showRegenerationPreview(index, result.title, result.new_content, result.current_content, result.user_original, result.used_source);
                } else {
                    alert('âŒ ì¬ìƒì„± ì‹¤íŒ¨: ' + (result.error || result.message));
                    viewDocument(index);
                }
            } catch (error) {
                console.error('ì¬ìƒì„± ì‹¤íŒ¨:', error);
                alert('âŒ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                viewDocument(index);
            }
        }
        
        // ì¬ìƒì„± ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function showRegenerationPreview(index, title, newContent, currentContent, userOriginal, usedSource) {
            const doc = allDocuments[index];
            const panel = document.getElementById('preview-panel');
            
            // Jë‹˜ ì›ë³¸ í‘œì‹œ ì—¬ë¶€
            const originalBox = userOriginal ? `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                    <strong>ğŸ“Œ Jë‹˜ ì›ë³¸ (ì°¸ê³ ):</strong>
                    <div style="white-space: pre-wrap; margin-top: 8px; font-size: 13px;">${userOriginal}</div>
                </div>
            ` : '';
            
            panel.innerHTML = `
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="margin: 0 0 10px 0;">âœ¨ ì¬ìƒì„± ì™„ë£Œ (ë¯¸ì €ì¥)</h3>
                    <h2 style="margin: 0 0 10px 0; color: #155724;">${title}</h2>
                    <p style="margin: 0; color: #155724;">ì†ŒìŠ¤: ${usedSource} | ì•„ë˜ ìƒˆ ë‚´ìš©ì„ í™•ì¸í•˜ê³  í”¼ë“œë°±ì„ ì£¼ì„¸ìš”!</p>
                </div>
                
                ${originalBox}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <strong>ğŸ“„ ê¸°ì¡´ AI ì‘ë‹µ:</strong>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; margin-top: 5px; line-height: 1.6;">${currentContent || 'ê¸°ì¡´ ë‚´ìš© ì—†ìŒ'}</div>
                    </div>
                    <div>
                        <strong>âœ¨ ìƒˆ AI ì‘ë‹µ (ìˆ˜ì • ê°€ëŠ¥):</strong>
                        <textarea id="new-content-editable" style="width: 100%; background: #e7f3ff; padding: 10px; border-radius: 5px; height: 400px; white-space: pre-wrap; font-size: 13px; margin-top: 5px; line-height: 1.6; border: 2px solid #007bff; font-family: inherit; resize: vertical;">${newContent}</textarea>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ’¬ í”¼ë“œë°± (ì„ íƒì‚¬í•­):</label>
                    <textarea id="regeneration-feedback" rows="3" placeholder="ì˜ˆ: 'Jë‹˜'ì´ë¼ëŠ” í‘œí˜„ ì œê±°í•´ì£¼ì„¸ìš”
ì˜ˆ: ë” ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”
ì˜ˆ: ì„ìƒ ë°ì´í„° ì¶”ê°€ í•„ìš”
ì˜ˆ: ã€Œã€ ê°™ì€ ë¶ˆí•„ìš”í•œ ê¸°í˜¸ ì œê±°" style="width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 8px; font-size: 14px;"></textarea>
                    <small style="color: #666;">ğŸ’¡ íŒ: êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„ ì£¼ë©´ ë” ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ìŠµë‹ˆë‹¤!</small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <button onclick="applyRegeneration(${index}, false)" style="background: #28a745;">âœ… ì´ëŒ€ë¡œ ì ìš©</button>
                    <button onclick="applyRegeneration(${index}, true)" style="background: #ffc107; color: #000;">ğŸ”„ í”¼ë“œë°± ë°˜ì˜ í›„ ì ìš©</button>
                    <button onclick="viewDocument(${index})" style="background: #6c757d;">âŒ ì·¨ì†Œ</button>
                </div>
            `;
        }
        
        // ì¬ìƒì„± ì ìš©
        async function applyRegeneration(index, useFeedback) {
            const doc = allDocuments[index];
            const feedback = document.getElementById('regeneration-feedback').value.trim();
            
            // ìˆ˜ì •ëœ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° (textareaì—ì„œ)
            const editedContent = document.getElementById('new-content-editable').value;
            
            if (useFeedback && !feedback) {
                alert('âŒ í”¼ë“œë°±ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            if (useFeedback) {
                const panel = document.getElementById('preview-panel');
                panel.innerHTML = '<div style="text-align: center; padding: 50px;">ğŸ”„ í”¼ë“œë°±ì„ ë°˜ì˜í•˜ëŠ” ì¤‘...<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>';
            }
            
            try {
                const response = await fetch('/api/v2/documents/apply-regeneration/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project: selectedProject,
                        collection: doc.collection,
                        doc_id: doc.id,
                        new_content: editedContent,  // ìˆ˜ì •ëœ ë‚´ìš© ì‚¬ìš©
                        feedback: useFeedback ? feedback : ''
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    if (result.feedback_applied) {
                        alert(`âœ… í”¼ë“œë°±ì´ ë°˜ì˜ë˜ì–´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!\n\ní”¼ë“œë°±: ${feedback}`);
                    } else {
                        alert('âœ… ì¬ìƒì„± ë‚´ìš©ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }
                    searchDocuments();
                    setTimeout(() => {
                        const newIndex = allDocuments.findIndex(d => d.id === doc.id);
                        if (newIndex >= 0) viewDocument(newIndex);
                    }, 500);
                } else {
                    alert('âŒ ì ìš© ì‹¤íŒ¨: ' + (result.error || result.message));
                }
            } catch (error) {
                console.error('ì ìš© ì‹¤íŒ¨:', error);
                alert('âŒ ì ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        // ì„ íƒ ë¬¸ì„œ ì •ë¦¬
        async function combineSelected() {
            const checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('âŒ ì •ë¦¬í•  ë¬¸ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            const selectedDocs = Array.from(checkboxes).map(cb => {
                const idx = parseInt(cb.dataset.index);
                const doc = allDocuments[idx];
                return {
                    collection: doc.collection,
                    doc_id: doc.id
                };
            });
            
            const title = prompt(`${selectedDocs.length}ê°œ ë¬¸ì„œë¥¼ ì •ë¦¬í•  ì œëª©:`, 'ì •ë¦¬ëœ ë¬¸ì„œ');
            if (!title) return;
            
            const target = prompt('ì €ì¥í•  ì»¬ë ‰ì…˜ (raw/draft/final):', 'draft');
            if (!['raw', 'draft', 'final'].includes(target)) {
                alert('âŒ ì˜¬ë°”ë¥¸ ì»¬ë ‰ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const response = await fetch('/api/v2/documents/combine/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project: selectedProject,
                        documents: selectedDocs,
                        target: target,
                        title: title
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert(`âœ… ${selectedDocs.length}ê°œ ë¬¸ì„œê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    searchDocuments();
                } else {
                    alert('âŒ ì •ë¦¬ ì‹¤íŒ¨: ' + (result.error || result.message));
                }
            } catch (error) {
                console.error('ì •ë¦¬ ì‹¤íŒ¨:', error);
                alert('âŒ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        // ì„ íƒ ì‚­ì œ
        async function deleteSelected() {
            const checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('âŒ ì‚­ì œí•  ë¬¸ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            if (!confirm(`ì •ë§ ${checkboxes.length}ê°œ ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”?\nì‚­ì œëœ ë¬¸ì„œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

            const selectedDocs = Array.from(checkboxes).map(cb => {
                const idx = parseInt(cb.dataset.index);
                const doc = allDocuments[idx];
                return {
                    collection: doc.collection,
                    doc_id: doc.id
                };
            });
            
            try {
                const response = await fetch('/api/v2/documents/delete/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project: selectedProject,
                        documents: selectedDocs
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert(`âœ… ${result.deleted}ê°œ ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    searchDocuments();
                } else {
                    alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || result.message));
                }
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        // FINAL ì´ë™
        async function moveToFinal(index) {
            const doc = allDocuments[index];
            
            if (!confirm(`"${doc.ì œëª© || doc.title}"ì„(ë¥¼) FINALë¡œ ì´ë™í• ê¹Œìš”?\n\nFINAL ì´ë™ í›„:\n- ë°ˆìŠ¤í† ë¦¬ ìƒì„±\n- ë°ˆì´ë¯¸ì§€ ìƒì„±\n- ìë§‰ ì‘ì„±\n- ìˆí¼ ì œì‘\në“±ì˜ ì‘ì—…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/v2/documents/move-to-final/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project: selectedProject,
                        collection: doc.collection,
                        doc_id: doc.id
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert(`âœ… FINALë¡œ ì´ë™ ì™„ë£Œ!\n\në‹¤ìŒ ì‘ì—…:\n- ë°ˆ ìë™í™”\n- ìˆí¼ ì œì‘\n- ì „ìì±… í¸ì§‘`);
                    searchDocuments();
                    setTimeout(() => {
                        // FINAL ì»¬ë ‰ì…˜ìœ¼ë¡œ ì „í™˜í•˜ì—¬ í™•ì¸
                        document.getElementById('collection-select').value = 'final';
                        searchDocuments();
                    }, 1000);
                } else {
                    alert('âŒ ì´ë™ ì‹¤íŒ¨: ' + (result.error || result.message));
                }
            } catch (error) {
                console.error('FINAL ì´ë™ ì‹¤íŒ¨:', error);
                alert('âŒ ì´ë™ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        // ì´ë¯¸ì§€ ìƒì„± UI í‘œì‹œ
        function showImageGenerator(index) {
            const doc = allDocuments[index];
            const panel = document.getElementById('preview-panel');
            
            panel.innerHTML = `
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                    <h2 style="margin: 0 0 10px 0;">ğŸ¨ ì´ë¯¸ì§€ ìƒì„±</h2>
                    <p style="margin: 0; opacity: 0.9;">ì „ìì±…/ì´ë¡  ì„¤ëª…ìš© ì´ë¯¸ì§€ë¥¼ AIë¡œ ìƒì„±í•©ë‹ˆë‹¤</p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 15px;">ğŸ“ ì´ë¯¸ì§€ ì„¤ëª… (í”„ë¡¬í”„íŠ¸):</label>
                    <textarea id="image-prompt" rows="4" placeholder="ì˜ˆ: ê³¨ë°˜ ëŒë¦¬ê¸° ë™ì‘ ì„¤ëª… ë‹¤ì´ì–´ê·¸ë¨, ê·¼ìœ¡ ê°•ì¡°, êµìœ¡ìš©
ì˜ˆ: í•˜ì´ë…¸ì›Œë° ìŠ¤íŠ¸ë ˆì¹­ ìì„¸ ì¼ëŸ¬ìŠ¤íŠ¸, ë¶€ë“œëŸ¬ìš´ ìƒ‰ìƒ
ì˜ˆ: ì²™ì¶” êµ¬ì¡° í•´ë¶€í•™ ê·¸ë¦¼, ëª…í™•í•œ ë¼ë²¨ë§" style="width: 100%; padding: 12px; border: 2px solid #ff6b6b; border-radius: 8px; font-size: 14px; font-family: 'Nanum Myeongjo', serif; resize: vertical;">${doc.ì œëª© || ''} ì„¤ëª… ì´ë¯¸ì§€</textarea>
                    <small style="color: #666;">ğŸ’¡ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í• ìˆ˜ë¡ ì›í•˜ëŠ” ì´ë¯¸ì§€ê°€ ìƒì„±ë©ë‹ˆë‹¤</small>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold; font-size: 15px;">ğŸ¨ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#ff6b6b'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'">
                            <input type="radio" name="image-style" value="diagram" checked onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => l.style.borderColor='#e0e0e0'); this.parentElement.style.borderColor='#ff6b6b';" style="margin-bottom: 5px;">
                            <div style="font-size: 13px; font-weight: 600;">ğŸ“Š ë‹¤ì´ì–´ê·¸ë¨</div>
                            <div style="font-size: 11px; color: #666;">ì„ ëª…, êµìœ¡ìš©</div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#ff6b6b'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'">
                            <input type="radio" name="image-style" value="illustration" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => l.style.borderColor='#e0e0e0'); this.parentElement.style.borderColor='#ff6b6b';" style="margin-bottom: 5px;">
                            <div style="font-size: 13px; font-weight: 600;">ğŸ¨ ì¼ëŸ¬ìŠ¤íŠ¸</div>
                            <div style="font-size: 11px; color: #666;">ë¶€ë“œëŸ¬ìš´, ì¹œê·¼í•œ</div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#ff6b6b'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'">
                            <input type="radio" name="image-style" value="realistic" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => l.style.borderColor='#e0e0e0'); this.parentElement.style.borderColor='#ff6b6b';" style="margin-bottom: 5px;">
                            <div style="font-size: 13px; font-weight: 600;">ğŸ“· ì‚¬ì‹¤ì </div>
                            <div style="font-size: 11px; color: #666;">ì‚¬ì§„ ê°™ì€</div>
                        </label>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 15px;">ğŸ“¸ ì´ë¯¸ì§€ í¬ê¸°:</label>
                    <select id="image-size" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        <option value="1024x1024">ì •ì‚¬ê°í˜• - ëŒ€ (1024x1024)</option>
                        <option value="1024x768" selected>ê°€ë¡œí˜• - ëŒ€ (1024x768)</option>
                        <option value="768x1024">ì„¸ë¡œí˜• - ëŒ€ (768x1024)</option>
                        <option value="512x512">ì •ì‚¬ê°í˜• - ì¤‘ (512x512)</option>
                        <option value="512x384">ê°€ë¡œí˜• - ì¤‘ (512x384)</option>
                        <option value="384x512">ì„¸ë¡œí˜• - ì¤‘ (384x512)</option>
                        <option value="256x256">ì •ì‚¬ê°í˜• - ì†Œ (256x256)</option>
                        <option value="256x192">ê°€ë¡œí˜• - ì†Œ (256x192)</option>
                        <option value="192x256">ì„¸ë¡œí˜• - ì†Œ (192x256)</option>
                    </select>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                    <strong>ğŸ’¡ íŒ:</strong>
                    <ul style="margin: 5px 0 0 20px; font-size: 13px; line-height: 1.6;">
                        <li>êµ¬ì²´ì ì¸ ì„¤ëª… ì¶”ê°€ (ìƒ‰ìƒ, ê°ë„, ìš”ì†Œ ë“±)</li>
                        <li>í•„ìš”í•œ ë¼ë²¨ì´ë‚˜ í…ìŠ¤íŠ¸ ëª…ì‹œ</li>
                        <li>ê¸°ì¡´ meme_images í´ë”ì˜ J/ì•„ë‚´ ìŠ¤íƒ€ì¼ ì°¸ê³  ê°€ëŠ¥</li>
                    </ul>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                    <button onclick="generateImage(${index})" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); font-size: 16px; padding: 15px;">âœ¨ ì´ë¯¸ì§€ ìƒì„±</button>
                    <button onclick="viewDocument(${index})" style="background: #6c757d; padding: 15px;">âŒ ì·¨ì†Œ</button>
                </div>
                
                <div id="image-result" style="margin-top: 20px;"></div>
            `;
        }

        // ì´ë¯¸ì§€ ìƒì„±
        async function generateImage(index) {
            const doc = allDocuments[index];
            const prompt = document.getElementById('image-prompt').value.trim();
            const style = document.querySelector('input[name="image-style"]:checked').value;
            const size = document.getElementById('image-size').value;
            
            if (!prompt) {
                alert('âŒ ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            const resultDiv = document.getElementById('image-result');
            resultDiv.innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 12px;"><div style="font-size: 18px; margin-bottom: 10px;">ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘...</div><div style="color: #666;">AIê°€ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div></div>';
            
            try {
                const response = await fetch('/api/v2/images/generate/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project: selectedProject,
                        doc_id: doc.id,
                        collection: doc.collection,
                        prompt: prompt,
                        style: style,
                        size: size
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; color: #155724;">âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!</h3>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                            <img src="${result.image_url}" class="ebook-image" alt="ìƒì„±ëœ ì´ë¯¸ì§€">
                            <div class="image-caption">${prompt}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">ğŸ“‹ ë§ˆí¬ë‹¤ìš´ (ë³µì‚¬í•´ì„œ ì‚¬ìš©):</label>
                            <input type="text" value="![${prompt}](${result.image_url})" readonly onclick="this.select()" style="width: 100%; padding: 10px; border: 2px solid #28a745; border-radius: 8px; font-family: monospace; font-size: 13px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <button onclick="insertImageToDocument(${index}, '${result.image_url}', '${prompt}')" style="background: #28a745;">ğŸ“„ ë¬¸ì„œì— ì‚½ì…</button>
                            <button onclick="showImageGenerator(${index})" style="background: #ffc107; color: #000;">ğŸ”„ ë‹¤ì‹œ ìƒì„±</button>
                            <button onclick="viewDocument(${index})" style="background: #667eea;">âœ… ì™„ë£Œ</button>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #f8d7da; padding: 20px; border-radius: 12px; border-left: 4px solid #dc3545;">
                            <h3 style="margin: 0 0 10px 0; color: #721c24;">âŒ ìƒì„± ì‹¤íŒ¨</h3>
                            <p style="margin: 0; color: #721c24;">${result.error || result.message}</p>
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="showImageGenerator(${index})" style="width: 100%; background: #667eea;">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 20px; border-radius: 12px; border-left: 4px solid #dc3545;">
                        <h3 style="margin: 0 0 10px 0; color: #721c24;">âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
                        <p style="margin: 0; color: #721c24;">ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="showImageGenerator(${index})" style="width: 100%; background: #667eea;">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }

        // ì´ë¯¸ì§€ë¥¼ ë¬¸ì„œì— ì‚½ì…
        async function insertImageToDocument(index, imageUrl, caption) {
            const doc = allDocuments[index];
            const currentContent = doc.ë‚´ìš©ì „ì²´ || doc.ë‚´ìš© || doc.content || '';
            
            // ì´ë¯¸ì§€ í¬ê¸°ì— ë”°ë¼ ë‹¤ë¥¸ ë ˆì´ì•„ì›ƒ ì ìš©
            const size = document.getElementById('image-size').value;
            const [width, height] = size.split('x').map(Number);
            
            let imageHtml = '';
            
            if (width >= 1024) {
                // í° ì´ë¯¸ì§€: ì¤‘ì•™ ì •ë ¬, ì „ì²´ ë„ˆë¹„
                imageHtml = `\n\n<div style="text-align: center; margin: 30px 0;">
    <img src="${imageUrl}" alt="${caption}" class="ebook-image" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.15);">
    <div class="image-caption" style="font-size: 14px; color: #666; font-style: italic; margin-top: 8px;">${caption}</div>
</div>\n\n`;
            } else if (width >= 512) {
                // ì¤‘ê°„ ì´ë¯¸ì§€: float left, í…ìŠ¤íŠ¸ ê°ì‹¸ê¸°
                imageHtml = `\n\n<div style="float: left; margin: 0 20px 15px 0; max-width: ${width}px;">
    <img src="${imageUrl}" alt="${caption}" style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="font-size: 12px; color: #666; font-style: italic; margin-top: 5px; text-align: center;">${caption}</div>
</div>\n\n`;
            } else {
                // ì‘ì€ ì´ë¯¸ì§€: float right, í…ìŠ¤íŠ¸ ê°ì‹¸ê¸°
                imageHtml = `\n\n<div style="float: right; margin: 0 0 15px 20px; max-width: ${width}px;">
    <img src="${imageUrl}" alt="${caption}" style="width: 100%; height: auto; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="font-size: 11px; color: #666; font-style: italic; margin-top: 5px; text-align: center;">${caption}</div>
</div>\n\n`;
            }
            
            const newContent = currentContent + imageHtml;
            
            console.log('[ì´ë¯¸ì§€ ì‚½ì…] ê¸°ì¡´ ë‚´ìš© ê¸¸ì´:', currentContent.length);
            console.log('[ì´ë¯¸ì§€ ì‚½ì…] ì´ë¯¸ì§€ URL:', imageUrl);
            console.log('[ì´ë¯¸ì§€ ì‚½ì…] ì´ë¯¸ì§€ í¬ê¸°:', size);
            console.log('[ì´ë¯¸ì§€ ì‚½ì…] ë ˆì´ì•„ì›ƒ:', width >= 1024 ? 'ì¤‘ì•™' : (width >= 512 ? 'ì¢Œì¸¡ float' : 'ìš°ì¸¡ float'));
            console.log('[ì´ë¯¸ì§€ ì‚½ì…] ìƒˆ ë‚´ìš© ê¸¸ì´:', newContent.length);
            
            try {
                const response = await fetch('/api/v2/documents/update/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project: selectedProject,
                        collection: doc.collection,
                        doc_id: doc.id,
                        updates: {
                            'ë‚´ìš©ì „ì²´': newContent,
                            'ë‚´ìš©': newContent
                        }
                    })
                });
                
                const result = await response.json();
                console.log('[ì´ë¯¸ì§€ ì‚½ì… ì‘ë‹µ]', result);
                
                if (result.status === 'success') {
                    alert('âœ… ì´ë¯¸ì§€ê°€ ë¬¸ì„œì— ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    
                    // ë¡œì»¬ ë°ì´í„° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    allDocuments[index].ë‚´ìš©ì „ì²´ = newContent;
                    allDocuments[index].ë‚´ìš© = newContent;
                    
                    // ë¬¸ì„œ ë‹¤ì‹œ í‘œì‹œ
                    viewDocument(index);
                } else {
                    alert('âŒ ì‚½ì… ì‹¤íŒ¨: ' + (result.error || result.message));
                }
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì‚½ì… ì‹¤íŒ¨:', error);
                alert('âŒ ì‚½ì… ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        }
    </script>
</body>
</html>
